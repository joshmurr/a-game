!function t(e,s,i){function o(n,r){if(!s[n]){if(!e[n]){var h="function"==typeof require&&require;if(!r&&h)return h(n,!0);if(a)return a(n,!0);var l=new Error("Cannot find module '"+n+"'");throw l.code="MODULE_NOT_FOUND",l}var c=s[n]={exports:{}};e[n][0].call(c.exports,(function(t){return o(e[n][1][t]||t)}),c,c.exports,t,e,s,i)}return s[n].exports}for(var a="function"==typeof require&&require,n=0;n<i.length;n++)o(i[n]);return o}({1:[function(t,e,s){AFRAME.registerComponent("include",{schema:{type:"string"},init:async function(){if(this.data&&!this.el.sceneEl._including_){this.el.sceneEl._including_=!0;let t=this.el.outerHTML,e=t.indexOf(" "),s=t.indexOf(" include="),i=t.substr(e,s-e);e=t.indexOf('"',s+10)+1,s=t.indexOf(">"),i+=t.substr(e,s-e);let o=await fetch(this.data);o.status>=200&&o.status<300?this.el.outerHTML=await(await o.text()).replace(">"," >").replace(" "," "+i+" "):this.el.removeAttribute("include"),this.el.sceneEl._including_=!1;let a=this.el.sceneEl.querySelector("[include]");a&&a.components&&a.components.include&&a.components.include.init()}}})},{}],2:[function(t,e,s){AFRAME.registerComponent("locomotion",{dependencies:["position"],schema:{acceleration:{type:"number",default:65},rotationSpeed:{type:"number",default:1},quantizeMovement:{type:"boolean",default:!1},quantizeRotation:{type:"boolean",default:!0},teleportDistance:{type:"number",default:3},godMode:{type:"boolean",default:!1}},init:function(){this.playCenter=new THREE.Vector3,this.playerPos=new THREE.Vector3,this.feetPos=new THREE.Vector3,this.safeHeadPos=new THREE.Vector3,this.safeFeetPos=new THREE.Vector3,this.cameraPos=new THREE.Vector3,this.cameraDir=new THREE.Vector3,this.angle=0,this.floorOffset=0,this._ensurePlayer(),this._camera=this.el.querySelector("a-camera"),this._cameraObj=this._camera.querySelector(".tracker"),this._leftHand=this.el.querySelector(".left-hand"),this._rightHand=this.el.querySelector(".right-hand"),this._cursor=this._camera.ensure("a-cursor.locomotion","a-cursor",{class:"locomotion",raycaster:{origin:{x:0,y:0,z:.5}},autoRefresh:!1,objects:"[floor], [wall]",position:{x:0,y:0,z:-.5}}),this._cursorBall=this._cursor.ensure("a-sphere","a-sphere",{radius:.0625,color:"#0ff",visible:!1}),this._vehicle=this.el.ensure(".locomotion-vehicle","a-entity",{class:"locomotion-vehicle",position:{x:0,y:.5,z:0},raycaster:{autoRefresh:!1,direction:{x:0,y:-1,z:0},far:.6,objects:"[floor]"}}),this._bumper=this._vehicle.ensure(".locomotion-bumper","a-entity",{class:"locomotion-bumper",raycaster:{autoRefresh:!1,direction:{x:1,y:0,z:0},far:1,objects:"[wall]"}}),this._helmet=this.el.ensure(".locomotion-helmet","a-entity",{class:"locomotion-helmet",position:{x:0,y:1.5,z:0},raycaster:{autoRefresh:!1,direction:{x:1,y:0,z:0},far:1,objects:"[wall], [floor]"}}),this.enableHands=this.enableHands.bind(this),this.toggleCrouch=this.toggleCrouch.bind(this),this._axisMove=this._axisMove.bind(this),this._buttonChanged=this._buttonChanged.bind(this),this._keyDown=this._keyDown.bind(this),this._keyUp=this._keyUp.bind(this),this._fireDown=this._fireDown.bind(this),this._fireUp=this._fireUp.bind(this),this._turnLeft=this._turnLeft.bind(this),this._turnRight=this._turnRight.bind(this),this._getBackUp=this._getBackUp.bind(this),this._rightHand.addEventListener("buttonchanged",this.enableHands),this._leftHand.addEventListener("axismove",this._axisMove),this._leftHand.addEventListener("buttonchanged",this._buttonChanged),this._rightHand.addEventListener("axismove",this._axisMove),this._rightHand.addEventListener("buttonchanged",this._buttonChanged),this._rightHand.addEventListener("buttonchanged",this.enableHands),addEventListener("keydown",this._keyDown),addEventListener("keyup",this._keyUp),document.querySelector("canvas").addEventListener("swipeleft",this._turnLeft),document.querySelector("canvas").addEventListener("swiperight",this._turnRight),document.querySelector("canvas").addEventListener("swipedown",this.toggleCrouch),document.querySelector("canvas").addEventListener("swipeup",this._fireDown),document.querySelector("canvas").addEventListener("touchend",this._fireUp),this._nextMove=0,this._targetDir=0,this._alt=0,this._lastFloorPos=new THREE.Vector3},update:function(){this._camera.setAttribute("wasd-controls","acceleration",this.data.acceleration),this._allowGod=this.data.godMode,this._godMode=this.data.godMode},remove:function(){this._rightHand.removeEventListener("buttonchanged",this.enableHands),this._leftHand.removeEventListener("axismove",this._axisMove),this._leftHand.removeEventListener("buttonchanged",this._buttonChanged),this._rightHand.removeEventListener("axismove",this._axisMove),this._rightHand.removeEventListener("buttonchanged",this._buttonChanged),this._rightHand.removeEventListener("buttonchanged",this.enableHands),removeEventListener("keydown",this._keyDown),removeEventListener("keyup",this._keyUp),document.querySelector("canvas").removeEventListener("swipeleft",this._turnLeft),document.querySelector("canvas").removeEventListener("swiperight",this._turnRight),document.querySelector("canvas").removeEventListener("swipedown",this.toggleCrouch),document.querySelector("canvas").removeEventListener("swipeup",this._fireDown),document.querySelector("canvas").removeEventListener("touchend",this._fireUp)},tick:function(t,e){let s,i,o,a,n,r=THREE.Vector2.temp(),h=THREE.Vector2.temp(),l=THREE.Vector2.temp(),c=THREE.Vector3.temp(),d=THREE.Matrix3.temp();if(this._cameraObj.object3D.updateMatrix(),this._cameraObj.object3D.getWorldPosition(this.cameraPos),this._cameraObj.object3D.getWorldDirection(this.cameraDir),this.el.object3D.getWorldPosition(this.playCenter),this.playerPos.set(this.cameraPos.x,this.playCenter.y-this.floorOffset,this.cameraPos.z),this.cameraPos.y<this.playerPos.y&&this.toggleCrouch(),c.set(this._camera.object3D.position.x-this._vehicle.object3D.position.x,0,this._camera.object3D.position.z-this._vehicle.object3D.position.z),c.length()>.5&&this._vehicle.object3D.position.add(c.multiplyScalar(.1)),this._vehicle.object3D.getWorldPosition(this.feetPos),this.feetPos.y=this.playerPos.y,c.set(this.safeFeetPos.x-this.feetPos.x,this.safeFeetPos.y-this.feetPos.y,this.safeFeetPos.z-this.feetPos.z),this._bumper.object3D.position.copy(c),this._bumper.setAttribute("raycaster","far",c.length()+.125),this._bumper.setAttribute("raycaster","direction",AFRAME.utils.coordinates.stringify(c.multiplyScalar(-1).normalize())),c.set(this.cameraPos.x-this.safeHeadPos.x,this.cameraPos.y-this.safeHeadPos.y,this.cameraPos.z-this.safeHeadPos.z),this.el.object3D.worldToLocal(this._helmet.object3D.position.copy(this.safeHeadPos)),this._helmet.setAttribute("raycaster","far",c.length()+.125),this._helmet.setAttribute("raycaster","direction",AFRAME.utils.coordinates.stringify(c.normalize())),!this._godMode){if(this._vehicle.components.raycaster.refreshObjects(),this._vehicle.components.raycaster.intersections[0]){let t=this._vehicle.components.raycaster.intersections[0],e=t.point;this.moveTo(this.playerPos.x,Math.max(e.y,this.playerPos.y-.1),this.playerPos.z),this._lastFloor==t.object.el&&(c.copy(this._lastFloor.object3D.position).sub(this._lastFloorPos),this.playCenter.add(c),this.playerPos.add(c),this.cameraPos.add(c),this.feetPos.add(c),this.el.object3D.position.add(c)),this._lastFloor=t.object.el,this._lastFloorPos.copy(this._lastFloor.object3D.position)}else this.moveTo(this.playerPos.x,this.playerPos.y-.1,this.playerPos.z),this._lastFloor=null;if(this._bumper.components.raycaster.refreshObjects(),this._bumper.components.raycaster.intersections[0]){let t=this._bumper.components.raycaster.intersections[0];d.getNormalMatrix(t.object.el.object3D.matrixWorld),c.copy(t.face.normal).applyMatrix3(d).normalize().multiplyScalar(.25),this.playCenter.add(c),this.playerPos.add(c),this.cameraPos.add(c),this.feetPos.add(c),this.el.object3D.position.add(c)}if(this.safeFeetPos.lerp(this.feetPos,.125),this._helmet.components.raycaster.refreshObjects(),this._helmet.components.raycaster.intersections[0]){let t=this._helmet.components.raycaster.intersections[0];d.getNormalMatrix(t.object.el.object3D.matrixWorld),c.copy(t.face.normal).applyMatrix3(d).normalize().multiplyScalar(.25),Math.abs(c.y)>Math.abs(c.x)&&Math.abs(c.y)>Math.abs(c.z)?(this.floorOffset+=c.y,this._vehicle.object3D.position.y=.5-this.floorOffset,setTimeout(this._getBackUp,1e4)):this.moveBy(c.x,c.y,c.z,!0)}this.safeHeadPos.lerp(this.cameraPos,.125)}h.set(this.cameraDir.z,-this.cameraDir.x),a=e*this.data.acceleration/25e3,n=e/1e3*-this.data.rotationSpeed,r.set(0,0);let p=0,u=0;for(this._btnDown=this._btnDown?this._btnDown-1:0,i=0,o=navigator.getGamepads().length;i<o;i++)s=navigator.getGamepads()[i],s&&(r.x+=Math.abs(s.axes[0])>.25?s.axes[0]:0,r.y+=Math.abs(s.axes[1])>.25?s.axes[1]:0,p+=Math.round(s.axes[2]),u+=Math.round(s.axes[3]),s.buttons[10].pressed&&(this._allowGod?0==this._btnDown&&(this._godMode=!this._godMode):0==this._btnDown&&(this.data.quantizeMovement=!this.data.quantizeMovement),this._btnDown=3),s.buttons[11].pressed&&(0==this._btnDown&&(this.data.quantizeRotation=!this.data.quantizeRotation),this._btnDown=3));if(this._axes&&(r.x+=Math.abs(this._axes[0])>.25?this._axes[0]:0,r.y+=Math.abs(this._axes[1])>.25?this._axes[1]:0,p+=Math.round(this._axes[2]),u+=Math.round(this._axes[3])),this.data.quantizeMovement&&(a=0,Math.round(r.length())&&(r.normalize(),this._nextMove<t&&(a=256*this.data.acceleration/25e3,this._nextMove=t+256))),this.data.quantizeRotation&&0!=p&&(n=this._rotated?0:-Math.PI/4),this._rotated=0!=p,u<0){this._alt>=0&&(this._cursor.setAttribute("raycaster","showLine",!0),this._cursorBall.setAttribute("visible",!0)),this._cursor.components.raycaster.refreshObjects();let t=this._cursor.components.raycaster.intersections[0];this._cursorBall.object3D.position.set(0,0,t&&-t.distance+this._cursor.components.raycaster.data.origin.z),t&&null!=t.object.el.getAttribute("floor")&&t.point.y<this.playerPos.y+1.5?(this._cursorBall.setAttribute("color","#0f0"),this.playerPos.distanceTo(t.point)>this.data.teleportDistance&&(c.copy(t.point).sub(this.playerPos),c.normalize().multiplyScalar(this.data.teleportDistance),this._cursorBall.object3D.parent.worldToLocal(this._cursorBall.object3D.position.copy(this.playerPos).add(c)))):this._cursorBall.setAttribute("color","#f00")}if(0==u&&this._alt<0){this._cursor.setAttribute("raycaster","showLine",!1),this._cursorBall.setAttribute("visible",!1);let t=this._cursor.components.raycaster.intersections[0];t&&null!=t.object.el.getAttribute("floor")&&t.point.y<this.playerPos.y+1.5&&(this.playerPos.distanceTo(t.point)<=this.data.teleportDistance?this.moveTo(t.point.x,t.point.y,t.point.z,!1,!0):(c.copy(t.point).sub(this.playerPos),c.normalize().multiplyScalar(this.data.teleportDistance).add(this.playerPos),this.moveTo(c.x,c.y,c.z,!1,!0)))}u>0&&this._alt<=0&&this.toggleCrouch(),this._alt=u,r.multiplyScalar(a);let y=r.y;this._godMode&&(r.y=0),l.set(0,0),r.rotateAround(l,h.angle()),p&&this.rotateBy(p*n),this.moveBy(r.x,0,r.y),this._godMode&&this.moveBy(this.cameraDir.x*y,this.cameraDir.y*y,this.cameraDir.z*y)},moveBy:function(t,e,s,i,o){let a=THREE.Vector3.temp(),n=THREE.Vector2.temp(),r=THREE.Vector2.temp();a.set(t,e,s),n.set(-t,-s),r.set(0,0),n.rotateAround(r,this.angle);let h=this._vehicle.object3D.position.y;this._vehicle.object3D.position.x+=n.x,this._vehicle.object3D.position.z+=n.y,this.playCenter.add(a),this.playerPos.add(a),this.cameraPos.add(a),this.el.object3D.position.add(a),(i||this._godMode)&&(this.safeFeetPos.copy(this.playerPos),this.safeHeadPos.copy(this.cameraPos)),(o||this._godMode)&&this._vehicle.object3D.position.copy(this._camera.object3D.position),this._vehicle.object3D.position.y=h},moveTo:function(t,e,s,i,o){this.moveBy(t-this.playerPos.x,e-this.playerPos.y,s-this.playerPos.z,i,o)},rotateBy:function(t){let e=THREE.Vector2.temp(),s=THREE.Vector2.temp(),i=THREE.Vector3.temp();this.moveTo(this.feetPos.x,this.feetPos.y,this.feetPos.z),e.set(this.playerPos.x,this.playerPos.z),s.set(this.playCenter.x,this.playCenter.z),e.rotateAround(s,-t),i.set(this.playerPos.x-e.x,0,this.playerPos.z-e.y),this.el.object3D.rotateY(t),this._vehicle.object3D.rotateY(-t),this.el.object3D.position.add(i),this.playCenter.add(i),this.angle+=t,this.angle>Math.PI&&(this.angle-=2*Math.PI),this.angle<-Math.PI&&(this.angle+=2*Math.PI)},enableHands:function(){let t=this._camera.querySelector("a-cursor");t&&(this._camera.removeChild(t),this._cursor=this._rightHand.ensure("a-cursor.locomotion","a-cursor",{autoRefresh:!1,class:"locomotion",objects:"[floor], [wall]",position:{x:0,y:0,z:0}}),this._cursorBall=this._cursor.ensure("a-sphere","a-sphere",{radius:.0625,color:"#0ff",visible:!1}),this._rightHand.removeEventListener("buttonchanged",this.enableHands),this.hasHands=!0)},toggleCrouch:function(){this.floorOffset?(this.floorOffset=0,this.moveTo(this.playerPos.x,this.playerPos.y+1.2,this.playerPos.z)):(this.floorOffset=-1,this.moveTo(this.playerPos.x,this.playerPos.y-.8,this.playerPos.z)),this._vehicle.object3D.position.y=.5-this.floorOffset},_ensurePlayer:function(){this.el.ensure("a-camera","a-camera",{"look-controls":{pointerLockEnabled:!0,touchEnabled:!1}}).ensure(".tracker","a-entity",{class:"tracker"});let t=.0625,e=this.el.ensure(".left-hand","a-entity",{class:"left-hand"}),s=e.ensure(".left-hitbox","a-box",{class:"left-hitbox",position:"0 -0 0.0625",material:"visible:false",width:.03125,height:t,depth:.125}).ensure(".left-glove","a-entity",{class:"left-glove",position:"0 0 -0.0625"}),i=this.el.ensure(".right-hand","a-entity",{class:"right-hand"}),o=i.ensure(".right-hitbox","a-box",{class:"right-hitbox",position:"0 -0 0.0625",material:"visible:false",width:.03125,height:t,depth:.125}).ensure(".right-glove","a-entity",{class:"right-glove",position:"0 0 -0.0625"});setTimeout((()=>{e.setAttribute("hand-controls",{hand:"left",handEntity:s}),i.setAttribute("hand-controls",{hand:"right",handEntity:o})}),256)},_axisMove:function(t){this._axes=this._axes||[],"left"===t.srcElement.getAttribute("hand-controls").hand?(this._axes[0]=t.detail.axis[2],this._axes[1]=t.detail.axis[3]):(this._axes[2]=t.detail.axis[2],this._axes[3]=t.detail.axis[3])},_buttonChanged:function(t){"left"===t.srcElement.getAttribute("hand-controls").hand?this._allowGod?3==t.detail.id&&t.detail.state.pressed&&(this._godMode=!this._godMode):3==t.detail.id&&t.detail.state.pressed&&(this.data.quantizeMovement=!this.data.quantizeMovement):3==t.detail.id&&t.detail.state.pressed&&(this.data.quantizeRotation=!this.data.quantizeRotation)},_turnLeft:function(t){this._axes=this._axes||[0,0,0,0],this._alt=this._alt||0,this._axes[2]=-1},_turnRight:function(t){this._axes=this._axes||[0,0,0,0],this._alt=this._alt||0,this._axes[2]=1},_fireDown:function(t){this._axes=this._axes||[0,0,0,0],this._alt=this._alt||0,this._axes[3]=-1},_fireUp:function(t){this._axes=this._axes||[0,0,0,0],this._alt=this._alt||0,this._axes[2]=0,this._axes[3]=0},_keyDown:function(t){"Space"==t.code&&(this._axes=this._axes||[0,0,0,0],this._alt=this._alt||0,this._axes[3]=-1),"KeyC"==t.code&&this.toggleCrouch(),this._allowGod&&"KeyG"==t.code&&(this._godMode=!this._godMode)},_keyUp:function(t){"Space"==t.code&&this._axes&&(this._axes[3]=0)},_getBackUp:function(t){this.floorOffset&&this.toggleCrouch()}}),AFRAME.registerComponent("floor",{schema:{physics:{type:"boolean",default:!0}},update:function(){this.data.physics&&!this.el.getAttribute("body")&&this.el.setAttribute("body","type:static")}}),AFRAME.registerComponent("wall",{schema:{physics:{type:"boolean",default:!0}},update:function(){this.data.physics&&!this.el.getAttribute("body")&&this.el.setAttribute("body","type:static")}}),AFRAME.registerComponent("start",{update:function(){let t=this.el.sceneEl.querySelector("[locomotion]").components.locomotion,e=this.el.object3D.position;console.log("starting at",e),setTimeout((()=>{t.moveTo(e.x,e.y+1,e.z,!0,!0),setTimeout((()=>{t.floorOffset&&t.toggleCrouch()}),256)}),256)}})},{}],3:[function(t,e,s){const i=t("../libs/cmdCodec");AFRAME.registerSystem("physics",{schema:{workerUrl:{type:"string"},gravity:{type:"vec3",default:{x:0,y:-9.8,z:0}},debug:{type:"boolean",default:!1}},update:function(){this.data.workerUrl?(this.worker||(this.worker=new Worker(this.data.workerUrl),this.worker.addEventListener("message",this.onMessage.bind(this))),this.bodies=this.bodies||[],this.movingBodies=this.movingBodies||[],this.joints=this.joints||[],this.buffers=[new Float64Array(8),new Float64Array(8)],this.worker.postMessage("world gravity = "+i.stringifyParam(this.data.gravity)),this._debug=this.data.debug):this.remove()},remove:function(){this.worker&&this.worker.terminate(),this.worker=null,this.bodies=[],this.movingBodies=[]},tick:function(t,e){if(!this.worker)return;if(this.buffers.length<2)return;let s=this.buffers.shift();if(s.length<8*this.movingBodies.length){let t=s.length;for(;t<8*this.movingBodies.length;)t*=2;let e=this.movingBodies;s=new Float64Array(t),s.fill(NaN);let i=THREE.Vector3.temp(),o=THREE.Quaternion.temp();for(let t=0;t<e.length;t++){let a=8*t;e[t]&&(e[t].object3D.getWorldPosition(i),s[a++]=i.x,s[a++]=i.y,s[a++]=i.z,a++,e[t].object3D.getWorldQuaternion(o),s[a++]=o.x,s[a++]=o.y,s[a++]=o.z,s[a++]=o.w)}}this.worker.postMessage(s,[s.buffer])},onMessage:function(t){if("string"==typeof t.data){let e=i.parse(t.data);switch(e.shift()){case"world":this.command(e)}}else if(t.data instanceof Float64Array)for(this.buffers.push(t.data);this.buffers.length>2;)this.buffers.shift()},command:function(t){switch("number"==typeof t[0]&&t.shift(),t.shift()){case"body":let e=t.shift(),s=this.bodies[e];s&&s.components.body.command(t)}}}),t("./physics/body"),t("./physics/shape"),t("./physics/joint")},{"../libs/cmdCodec":8,"./physics/body":4,"./physics/joint":5,"./physics/shape":6}],4:[function(t,e,s){const i=t("../../libs/cmdCodec");AFRAME.registerComponent("body",{dependencies:["position","rotation","scale"],schema:{type:{type:"string",default:"static"},mass:{type:"number",default:1},belongsTo:{type:"int",default:1},collidesWith:{type:"int",default:1},emitsWith:{type:"int",default:0},sleeping:{type:"boolean",default:!1},autoShape:{type:"boolean",default:!0}},init:function(){let t=this.el.sceneEl.systems.physics.worker,e=this.el.sceneEl.systems.physics.bodies,s=this.el.sceneEl.systems.physics.movingBodies,o=this.el.sceneEl.systems.physics.buffers[0];if(!t)return;this.id=e.indexOf(null),this.id<0&&(this.id=e.length),e[this.id]=this.el,"static"!==this.data.type?(this.mid=s.indexOf(null),this.mid<0&&(this.mid=s.length),s[this.mid]=this.el):this.mid=null;let a={mid:this.mid};if(a.type=this.data.type,a.position=this.el.object3D.getWorldPosition(THREE.Vector3.temp()),a.quaternion=this.el.object3D.getWorldQuaternion(THREE.Quaternion.temp()),null!==this.mid){let t=8*this.mid;o[t++]=a.position.x,o[t++]=a.position.y,o[t++]=a.position.z,o[t++]=this.data.sleeping,o[t++]=a.quaternion.x,o[t++]=a.quaternion.y,o[t++]=a.quaternion.z,o[t++]=a.quaternion.w}if(this.shapes=[],this.sleeping=!0,t.postMessage("world body "+this.id+" create "+i.stringifyParam(a)),setTimeout((()=>{a.position=this.el.object3D.getWorldPosition(THREE.Vector3.temp()),a.quaternion=this.el.object3D.getWorldQuaternion(THREE.Quaternion.temp()),t.postMessage("world body "+this.id+" position = "+i.stringifyParam(a.position)),t.postMessage("world body "+this.id+" quaternion = "+i.stringifyParam(a.quaternion))})),this.data.autoShape&&!this.el.getAttribute("shape"))if(this.el.firstElementChild){let t=this.el.querySelectorAll("a-box, a-sphere, a-cylinder");t&&t.forEach((t=>{t.getAttribute("shape")||t.setAttribute("shape",!0)}))}else this.el.setAttribute("shape",!0)},update:function(t){let e=this.el.sceneEl.systems.physics.worker;e&&(this.data.type!==t.type&&e.postMessage("world body "+this.id+" type = "+i.stringifyParam(this.data.type)),this.data.mass!==t.mass&&e.postMessage("world body "+this.id+" mass = "+i.stringifyParam(this.data.mass)),this.data.belongsTo!==t.belongsTo&&e.postMessage("world body "+this.id+" belongsTo = "+i.stringifyParam(this.data.belongsTo)),this.data.collidesWith!==t.collidesWith&&e.postMessage("world body "+this.id+" collidesWith = "+i.stringifyParam(this.data.collidesWith)),this.data.emitsWith!==t.emitsWith&&e.postMessage("world body "+this.id+" emitsWith = "+i.stringifyParam(this.data.emitsWith)),setTimeout((()=>{e.postMessage("world body "+this.id+" sleeping = "+!!this.data.sleeping)})))},pause:function(){let t=this.el.sceneEl.systems.physics.worker;t&&(t.postMessage("world body "+this.id+" sleeping = true"),this.sleeping=!0)},remove:function(){let t=this.el.sceneEl.systems.physics.worker,e=this.el.sceneEl.systems.physics.bodies,s=this.el.sceneEl.systems.physics.movingBodies;t&&(e[this.id]=null,null!==this.mid&&(s[this.mid]=null),t.postMessage("world body "+this.id+" remove"))},tick:function(){let t=this.el.sceneEl.systems.physics.worker,e=this.el.sceneEl.systems.physics.buffers[0];if(t&&null!==this.mid){let t=8*this.mid;if(e.length<=t)return;if("kinematic"===this.data.type){let s=this.el.object3D.getWorldPosition(THREE.Vector3.temp());e[t++]=s.x,e[t++]=s.y,e[t++]=s.z,this.sleeping=!!e[t++];let i=this.el.object3D.getWorldQuaternion(THREE.Quaternion.temp());e[t++]=i.x,e[t++]=i.y,e[t++]=i.z,e[t++]=i.w}else if(e[t+1]){let s=THREE.Quaternion.temp();this.el.object3D.position.set(e[t++],e[t++],e[t++]),this.el.object3D.parent.worldToLocal(this.el.object3D.position),this.sleeping=!!e[t++],this.el.object3D.getWorldQuaternion(s),this.el.object3D.quaternion.multiply(s.conjugate().normalize()),s.set(e[t++],e[t++],e[t++],e[t++]),this.el.object3D.quaternion.multiply(s.normalize())}}},command:function(t){switch(t.shift()){case"emits":let e=t.shift();switch(e.event){case"collision":let t=this.el.sceneEl.systems.physics.bodies;if(e.body1=t[e.body1],e.body2=t[e.body2],!e.body1||!e.body2)return;e.shape1=e.body1.components.body.shapes[e.shape1],e.shape2=e.body2.components.body.shapes[e.shape2]}this.el.emit(e.event,e)}}})},{"../../libs/cmdCodec":8}],5:[function(t,e,s){const i=t("../../libs/cmdCodec");AFRAME.registerComponent("joint",{multiple:!0,schema:{type:{type:"string",default:"ball"},body1:{type:"selector"},body2:{type:"selector"},pivot1:{type:"vec3",default:{x:0,y:0,z:0}},pivot2:{type:"vec3",default:{x:0,y:0,z:0}},axis1:{type:"vec3",default:{x:0,y:1,z:0}},axis2:{type:"vec3",default:{x:0,y:1,z:0}},min:{type:"number",default:0},max:{type:"number",default:1},collision:{type:"boolean",default:!0}},init:function(){let t=this.el.sceneEl.systems.physics.worker,e=this.el.sceneEl.systems.physics.joints;t&&(this.id=e.indexOf(null),this.id<0&&(this.id=e.length),e[this.id]=this.el,setTimeout((()=>{let e={};e.type=this.data.type,e.body1=this.data.body1?this.data.body1.components.body.id:this.el.components.body.id,e.body2=this.data.body2.components.body.id,e.pivot1=this.data.pivot1,e.pivot2=this.data.pivot2,e.axis1=this.data.axis1,e.axis2=this.data.axis2,e.min=this.data.min,e.max=this.data.max,e.collision=this.data.collision,t.postMessage("world joint "+this.id+" create "+i.stringifyParam(e))})))},update:function(t){this.el.sceneEl.systems.physics.worker},remove:function(){let t=this.el.sceneEl.systems.physics.worker,e=this.el.sceneEl.systems.physics.joints;t&&(e[this.id]=null,t.postMessage("world joint "+this.id+" remove"))}})},{"../../libs/cmdCodec":8}],6:[function(t,e,s){const i=t("../../libs/cmdCodec");AFRAME.registerComponent("shape",{multiple:!0,schema:{},init:function(){let t=this.el.sceneEl.systems.physics.worker;t&&setTimeout((()=>{for(this.body=this.el;this.body&&!this.body.matches("[body]");)this.body=this.body.parentElement;this.bodyId=this.body.components.body.id;let e=this.body.components.body.shapes;this.id=e.indexOf(null),this.id<0&&(this.id=e.length),e[this.id]=this.el;let s={};s.position=this.el.object3D.getWorldPosition(THREE.Vector3.temp()),this.body.object3D.worldToLocal(s.position),s.quaternion=this.el.object3D.getWorldQuaternion(THREE.Quaternion.temp());let o=this.body.object3D.getWorldQuaternion(THREE.Quaternion.temp());switch(s.quaternion.multiply(o.conjugate().normalize()).normalize(),s.size=THREE.Vector3.temp().set(1,1,1),this.el.tagName.toLowerCase()){case"a-sphere":s.type="sphere",s.size.multiplyScalar(2*parseFloat(this.el.getAttribute("radius")||1));break;case"a-cylinder":s.type="cylinder",s.size.multiplyScalar(2*parseFloat(this.el.getAttribute("radius")||1)).y=parseFloat(this.el.getAttribute("height")||1);break;case"a-box":s.type="box",s.size.set(parseFloat(this.el.getAttribute("width")||1),parseFloat(this.el.getAttribute("height")||1),parseFloat(this.el.getAttribute("depth")||1))}t.postMessage("world body "+this.bodyId+" shape "+this.id+" create "+i.stringifyParam(s))}))},update:function(){},remove:function(){let t=this.el.sceneEl.systems.physics.worker,e=this.body.components.body.shapes;t.postMessage("world body "+this.bodyId+" shape "+this.id+" remove"),e[this.id]=null}})},{"../../libs/cmdCodec":8}],7:[function(t,e,s){t("./libs/pools"),t("./libs/copyWorldPosRot"),t("./libs/ensureElement"),t("./libs/touchGestures"),setTimeout((()=>{document.body.addEventListener("swipeup",(t=>{document.body.requestFullscreen()}))})),t("./components/include"),t("./components/physics"),t("./components/locomotion")},{"./components/include":1,"./components/locomotion":2,"./components/physics":3,"./libs/copyWorldPosRot":9,"./libs/ensureElement":10,"./libs/pools":11,"./libs/touchGestures":12}],8:[function(t,e,s){e.exports={parse:function(t){let e=t.split(" "),s=[];for(let t of e)if(t)try{s.push(JSON.parse(t))}catch(e){"="!==t&&s.push(t)}return s},stringifyParam:function(t){return JSON.stringify(t).replaceAll(" ","\\u0020").replaceAll('"_','"')}}},{}],9:[function(t,e,s){AFRAME.AEntity.prototype.copyWorldPosRot=function(t){let e=THREE.Quaternion.temp(),s=t.object3D,i=this.object3D;s&&i&&i.parent&&(s.getWorldPosition(i.position),i.parent.worldToLocal(i.position),i.getWorldQuaternion(e),i.quaternion.multiply(e.conjugate().normalize()),s.getWorldQuaternion(e),i.quaternion.multiply(e.normalize()))}},{}],10:[function(t,e,s){Element.prototype.ensure=function(t,e=t,s={}){let i,o,a;if(i=this.querySelector(t),!i)for(o in i=document.createElement(e),this.appendChild(i),s)a=s[o],i.setAttribute(o,a);return i}},{}],11:[function(t,e,s){function i(t){t._pool=[],t._inUse=[],t.temp=function(){let e=t._pool.pop()||new t;return t._inUse.push(e),t._gc||(t._gc=setTimeout(t._recycle)),e},t._recycle=function(){for(;t._inUse.length;)t._pool.push(t._inUse.pop());t._gc=!1}}i(THREE.Vector2),i(THREE.Vector3),i(THREE.Quaternion),i(THREE.Matrix3),i(THREE.Matrix4)},{}],12:[function(t,e,s){let i=Element.prototype.addEventListener,o=Element.prototype.removeEventListener,a=t=>{if(t._tgest)return t._tgest;let e,s,i,o;t._tgest={handlers:{swipeup:[],swipedown:[],swipeleft:[],swiperight:[],tap:[],hold:[]}};let a=(e,s)=>{if(t._tgest.handlers[e])for(let i of t._tgest.handlers[e])i(s);else console.log(e,t._tgest.handlers[e])};return t.addEventListener("touchstart",(t=>{e=t.changedTouches[0].screenX,s=t.changedTouches[0].screenY,o=!1,i=setTimeout((()=>{o=!0,a("hold",t)}),512)})),t.addEventListener("touchmove",(t=>{let n=t.changedTouches[0].screenX,r=t.changedTouches[0].screenY;if(Math.sqrt(Math.pow(e-n,2)+Math.pow(s-r,2))>32){if(clearTimeout(i),o)return;Math.abs(e-n)>Math.abs(s-r)?a(n<e?"swipeleft":"swiperight",t):a(r<s?"swipeup":"swipedown",t),o=!0}})),t.addEventListener("touchend",(t=>{clearTimeout(i);let n=t.changedTouches[0].screenX,r=t.changedTouches[0].screenY;if(Math.sqrt(Math.pow(e-n,2)+Math.pow(s-r,2))<32){if(o)return;a("tap",t)}})),t._tgest};Element.prototype.addEventListener=function(t,e){switch(t){case"swipeup":case"swipedown":case"swipeleft":case"swiperight":case"tap":case"hold":a(this).handlers[t].push(e);break;default:return i.call(this,t,e)}},Element.prototype.removeEventListener=function(t,e){switch(t){case"swipeup":case"swipedown":case"swipeleft":case"swiperight":case"tap":case"hold":let s=a(this),i=s.handlers[t].indexOf(e);i>=0&&s.handlers[t].splice(i,1);break;default:return o.call(this,t,e)}}},{}]},{},[7]);
