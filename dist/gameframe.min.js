!function t(e,s,i){function o(l,a){if(!s[l]){if(!e[l]){var r="function"==typeof require&&require;if(!a&&r)return r(l,!0);if(n)return n(l,!0);var h=new Error("Cannot find module '"+l+"'");throw h.code="MODULE_NOT_FOUND",h}var d=s[l]={exports:{}};e[l][0].call(d.exports,(function(t){return o(e[l][1][t]||t)}),d,d.exports,t,e,s,i)}return s[l].exports}for(var n="function"==typeof require&&require,l=0;l<i.length;l++)o(i[l]);return o}({1:[function(t,e,s){AFRAME.registerComponent("include",{schema:{type:"string"},init:async function(){if(this.data&&!this.el.sceneEl._including_){this.el.sceneEl._including_=!0;let t="",e=this.el;for(;e&&!e.dataset.includeBase;)e=e.parentElement;e&&(t=e.dataset.includeBase);let s=this.data;"/"!==s.substr(0,1)&&"http"!==s.substr(0,4)&&(s=t+s),s.indexOf("/")>=0&&(this.el.dataset.includeBase=s.substr(0,s.lastIndexOf("/")+1));let i=this.el.outerHTML,o=i.indexOf(" "),n=i.indexOf(" include="),l=i.substr(o,n-o);o=i.indexOf('"',n+10)+1,n=i.indexOf(">"),l+=i.substr(o,n-o);let a=await fetch(s);a.status>=200&&a.status<300?this.el.outerHTML=await(await a.text()).replace(">"," >").replace(" "," "+l+" "):(this.el.removeAttribute("include"),delete this.el.dataset.includeBase),this.el.sceneEl._including_=!1;let r=this.el.sceneEl.querySelector("[include]");r&&r.components&&r.components.include&&r.components.include.init()}}})},{}],2:[function(t,e,s){const i=t("../libs/cmdCodec");AFRAME.registerSystem("physics",{schema:{workerUrl:{type:"string"},gravity:{type:"vec3",default:{x:0,y:-9.8,z:0}},debug:{type:"boolean",default:!1}},update:function(){this.data.workerUrl?(this.worker||(this.worker=new Worker(this.data.workerUrl),this.worker.addEventListener("message",this.onMessage.bind(this))),this.bodies=this.bodies||[],this.movingBodies=this.movingBodies||[],this.joints=this.joints||[],this.buffers=[new Float64Array(8),new Float64Array(8)],this.worker.postMessage("world gravity = "+i.stringifyParam(this.data.gravity)),this._debug=this.data.debug):this.remove()},remove:function(){this.worker&&this.worker.terminate(),this.worker=null,this.bodies=[],this.movingBodies=[]},tick:function(t,e){if(!this.worker)return;if(this.buffers.length<2)return;let s=this.buffers.shift();if(s.length<8*this.movingBodies.length){let t=s.length;for(;t<8*this.movingBodies.length;)t*=2;let e=this.movingBodies;s=new Float64Array(t),s.fill(NaN);let i=THREE.Vector3.temp(),o=THREE.Quaternion.temp();for(let t=0;t<e.length;t++){let n=8*t;e[t]&&(e[t].object3D.getWorldPosition(i),s[n++]=i.x,s[n++]=i.y,s[n++]=i.z,n++,e[t].object3D.getWorldQuaternion(o),s[n++]=o.x,s[n++]=o.y,s[n++]=o.z,s[n++]=o.w)}}this.worker.postMessage(s,[s.buffer])},onMessage:function(t){if("string"==typeof t.data){let e=i.parse(t.data);switch(e.shift()){case"world":this.command(e)}}else if(t.data instanceof Float64Array)for(this.buffers.push(t.data);this.buffers.length>2;)this.buffers.shift()},command:function(t){switch("number"==typeof t[0]&&t.shift(),t.shift()){case"body":let e=t.shift(),s=this.bodies[e];s&&s.components.body.command(t)}}}),t("./physics/body"),t("./physics/shape"),t("./physics/joint")},{"../libs/cmdCodec":7,"./physics/body":3,"./physics/joint":4,"./physics/shape":5}],3:[function(t,e,s){const i=t("../../libs/cmdCodec");AFRAME.registerComponent("body",{dependencies:["position","rotation","scale"],schema:{type:{type:"string",default:"static"},mass:{type:"number",default:1},belongsTo:{type:"int",default:1},collidesWith:{type:"int",default:1},emitsWith:{type:"int",default:0},sleeping:{type:"boolean",default:!1},autoShape:{type:"boolean",default:!0}},init:function(){let t=this.el.sceneEl.systems.physics.worker,e=this.el.sceneEl.systems.physics.bodies,s=this.el.sceneEl.systems.physics.movingBodies,o=this.el.sceneEl.systems.physics.buffers[0];if(!t)return;this.id=e.indexOf(null),this.id<0&&(this.id=e.length),e[this.id]=this.el,"static"!==this.data.type?(this.mid=s.indexOf(null),this.mid<0&&(this.mid=s.length),s[this.mid]=this.el):this.mid=null;let n={mid:this.mid};if(n.type=this.data.type,n.position=this.el.object3D.getWorldPosition(THREE.Vector3.temp()),n.quaternion=this.el.object3D.getWorldQuaternion(THREE.Quaternion.temp()),null!==this.mid){let t=8*this.mid;o[t++]=n.position.x,o[t++]=n.position.y,o[t++]=n.position.z,o[t++]=this.data.sleeping,o[t++]=n.quaternion.x,o[t++]=n.quaternion.y,o[t++]=n.quaternion.z,o[t++]=n.quaternion.w}if(this.shapes=[],this.sleeping=!0,t.postMessage("world body "+this.id+" create "+i.stringifyParam(n)),setTimeout((()=>{n.position=this.el.object3D.getWorldPosition(THREE.Vector3.temp()),n.quaternion=this.el.object3D.getWorldQuaternion(THREE.Quaternion.temp()),t.postMessage("world body "+this.id+" position = "+i.stringifyParam(n.position)),t.postMessage("world body "+this.id+" quaternion = "+i.stringifyParam(n.quaternion))})),this.data.autoShape&&!this.el.getAttribute("shape"))if(this.el.firstElementChild){let t=this.el.querySelectorAll("a-box, a-sphere, a-cylinder");t&&t.forEach((t=>{t.getAttribute("shape")||t.setAttribute("shape",!0)}))}else this.el.setAttribute("shape",!0)},update:function(t){let e=this.el.sceneEl.systems.physics.worker;e&&(this.data.type!==t.type&&e.postMessage("world body "+this.id+" type = "+i.stringifyParam(this.data.type)),this.data.mass!==t.mass&&e.postMessage("world body "+this.id+" mass = "+i.stringifyParam(this.data.mass)),this.data.belongsTo!==t.belongsTo&&e.postMessage("world body "+this.id+" belongsTo = "+i.stringifyParam(this.data.belongsTo)),this.data.collidesWith!==t.collidesWith&&e.postMessage("world body "+this.id+" collidesWith = "+i.stringifyParam(this.data.collidesWith)),this.data.emitsWith!==t.emitsWith&&e.postMessage("world body "+this.id+" emitsWith = "+i.stringifyParam(this.data.emitsWith)),setTimeout((()=>{e.postMessage("world body "+this.id+" sleeping = "+!!this.data.sleeping)})))},pause:function(){let t=this.el.sceneEl.systems.physics.worker;t&&(t.postMessage("world body "+this.id+" sleeping = true"),this.sleeping=!0)},remove:function(){let t=this.el.sceneEl.systems.physics.worker,e=this.el.sceneEl.systems.physics.bodies,s=this.el.sceneEl.systems.physics.movingBodies;t&&(e[this.id]=null,null!==this.mid&&(s[this.mid]=null),t.postMessage("world body "+this.id+" remove"))},tick:function(){let t=this.el.sceneEl.systems.physics.worker,e=this.el.sceneEl.systems.physics.buffers[0];if(t&&null!==this.mid){let t=8*this.mid;if(e.length<=t)return;if("kinematic"===this.data.type){let s=this.el.object3D.getWorldPosition(THREE.Vector3.temp());e[t++]=s.x,e[t++]=s.y,e[t++]=s.z,this.sleeping=!!e[t++];let i=this.el.object3D.getWorldQuaternion(THREE.Quaternion.temp());e[t++]=i.x,e[t++]=i.y,e[t++]=i.z,e[t++]=i.w}else if(e[t+1]){let s=THREE.Quaternion.temp();this.el.object3D.position.set(e[t++],e[t++],e[t++]),this.el.object3D.parent.worldToLocal(this.el.object3D.position),this.sleeping=!!e[t++],this.el.object3D.getWorldQuaternion(s),this.el.object3D.quaternion.multiply(s.conjugate().normalize()),s.set(e[t++],e[t++],e[t++],e[t++]),this.el.object3D.quaternion.multiply(s.normalize())}}},command:function(t){switch(t.shift()){case"emits":let e=t.shift();switch(e.event){case"collision":let t=this.el.sceneEl.systems.physics.bodies;if(e.body1=t[e.body1],e.body2=t[e.body2],!e.body1||!e.body2)return;e.shape1=e.body1.components.body.shapes[e.shape1],e.shape2=e.body2.components.body.shapes[e.shape2]}this.el.emit(e.event,e)}}})},{"../../libs/cmdCodec":7}],4:[function(t,e,s){const i=t("../../libs/cmdCodec");AFRAME.registerComponent("joint",{multiple:!0,schema:{type:{type:"string",default:"ball"},body1:{type:"selector"},body2:{type:"selector"},pivot1:{type:"vec3",default:{x:0,y:0,z:0}},pivot2:{type:"vec3",default:{x:0,y:0,z:0}},axis1:{type:"vec3",default:{x:0,y:1,z:0}},axis2:{type:"vec3",default:{x:0,y:1,z:0}},min:{type:"number",default:0},max:{type:"number",default:1},collision:{type:"boolean",default:!0}},init:function(){let t=this.el.sceneEl.systems.physics.worker,e=this.el.sceneEl.systems.physics.joints;t&&(this.id=e.indexOf(null),this.id<0&&(this.id=e.length),e[this.id]=this.el,setTimeout((()=>{let e={};e.type=this.data.type,e.body1=this.data.body1?this.data.body1.components.body.id:this.el.components.body.id,e.body2=this.data.body2.components.body.id,e.pivot1=this.data.pivot1,e.pivot2=this.data.pivot2,e.axis1=this.data.axis1,e.axis2=this.data.axis2,e.min=this.data.min,e.max=this.data.max,e.collision=this.data.collision,t.postMessage("world joint "+this.id+" create "+i.stringifyParam(e))})))},update:function(t){this.el.sceneEl.systems.physics.worker},remove:function(){let t=this.el.sceneEl.systems.physics.worker,e=this.el.sceneEl.systems.physics.joints;t&&(e[this.id]=null,t.postMessage("world joint "+this.id+" remove"))}})},{"../../libs/cmdCodec":7}],5:[function(t,e,s){const i=t("../../libs/cmdCodec");AFRAME.registerComponent("shape",{multiple:!0,schema:{},init:function(){for(this.body=this.el;this.body&&!this.body.matches("[body]");)this.body=this.body.parentElement;this.bodyId=this.body.components.body.id;let t=this.el.sceneEl.systems.physics.worker,e=this.body.components.body.shapes;if(!t)return;this.id=e.indexOf(null),this.id<0&&(this.id=e.length),e[this.id]=this.el;let s={};s.position=this.el.object3D.getWorldPosition(THREE.Vector3.temp()),this.body.object3D.worldToLocal(s.position),s.quaternion=this.el.object3D.getWorldQuaternion(THREE.Quaternion.temp());let o=this.body.object3D.getWorldQuaternion(THREE.Quaternion.temp());switch(s.quaternion.multiply(o.conjugate().normalize()).normalize(),s.size=THREE.Vector3.temp().set(1,1,1),this.el.tagName.toLowerCase()){case"a-sphere":s.type="sphere",s.size.multiplyScalar(2*parseFloat(this.el.getAttribute("radius")||1));break;case"a-cylinder":s.type="cylinder",s.size.multiplyScalar(2*parseFloat(this.el.getAttribute("radius")||1)).y=parseFloat(this.el.getAttribute("height")||1);break;case"a-box":s.type="box",s.size.set(parseFloat(this.el.getAttribute("width")||1),parseFloat(this.el.getAttribute("height")||1),parseFloat(this.el.getAttribute("depth")||1))}t.postMessage("world body "+this.bodyId+" shape "+this.id+" create "+i.stringifyParam(s))},update:function(){},remove:function(){let t=this.el.sceneEl.systems.physics.worker,e=this.body.components.body.shapes;t.postMessage("world body "+this.bodyId+" shape "+this.id+" remove"),e[this.id]=null}})},{"../../libs/cmdCodec":7}],6:[function(t,e,s){t("./libs/pools"),t("./libs/copyWorldPosRot"),t("./components/include"),t("./components/physics")},{"./components/include":1,"./components/physics":2,"./libs/copyWorldPosRot":8,"./libs/pools":9}],7:[function(t,e,s){e.exports={parse:function(t){let e=t.split(" "),s=[];for(let t of e)if(t)try{s.push(JSON.parse(t))}catch(e){"="!==t&&s.push(t)}return s},stringifyParam:function(t){return JSON.stringify(t).replaceAll(" ","\\u0020").replaceAll('"_','"')}}},{}],8:[function(t,e,s){AFRAME.AEntity.prototype.copyWorldPosRot=function(t){let e=THREE.Quaternion.temp(),s=t.object3D,i=this.object3D;s&&i&&i.parent&&(s.getWorldPosition(i.position),i.parent.worldToLocal(i.position),i.getWorldQuaternion(e),i.quaternion.multiply(e.conjugate().normalize()),s.getWorldQuaternion(e),i.quaternion.multiply(e.normalize()))}},{}],9:[function(t,e,s){function i(t){t._pool=[],t._inUse=[],t.temp=function(){let e=t._pool.pop()||new t;return t._inUse.push(e),t._gc||(t._gc=setTimeout(t._recycle)),e},t._recycle=function(){for(;t._inUse.length;)t._pool.push(t._inUse.pop());t._gc=!1}}i(THREE.Vector2),i(THREE.Vector3),i(THREE.Quaternion),i(THREE.Matrix3),i(THREE.Matrix4)},{}]},{},[6]);
