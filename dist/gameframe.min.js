!function t(e,i,s){function o(l,r){if(!i[l]){if(!e[l]){var a="function"==typeof require&&require;if(!r&&a)return a(l,!0);if(n)return n(l,!0);var h=new Error("Cannot find module '"+l+"'");throw h.code="MODULE_NOT_FOUND",h}var d=i[l]={exports:{}};e[l][0].call(d.exports,(function(t){return o(e[l][1][t]||t)}),d,d.exports,t,e,i,s)}return i[l].exports}for(var n="function"==typeof require&&require,l=0;l<s.length;l++)o(s[l]);return o}({1:[function(t,e,i){AFRAME.registerComponent("include",{schema:{type:"string"},init:async function(){if(this.data&&!this.el.sceneEl._including_){this.el.sceneEl._including_=!0;let t=await fetch(this.data);t.status>=200&&t.status<300?this.el.outerHTML=await t.text():this.el.removeAttribute("include"),this.el.sceneEl._including_=!1;let e=this.el.sceneEl.querySelector("[include]");e&&e.components.include.init()}}})},{}],2:[function(t,e,i){const s=t("../libs/cmdCodec");AFRAME.registerSystem("physics",{schema:{workerUrl:{type:"string"},gravity:{type:"vec3",default:{x:0,y:-9.8,z:0}},debug:{type:"boolean",default:!1}},update:function(){this.data.workerUrl?(this.worker||(this.worker=new Worker(this.data.workerUrl),this.worker.addEventListener("message",this.onMessage.bind(this))),this.bodies=this.bodies||[],this.movingBodies=this.movingBodies||[],this.joints=this.joints||[],this.buffers=[new Float64Array(8),new Float64Array(8)],this.worker.postMessage("world gravity = "+s.stringifyParam(this.data.gravity)),this._debug=this.data.debug):this.remove()},remove:function(){this.worker&&this.worker.terminate(),this.worker=null,this.bodies=[],this.movingBodies=[]},tick:function(t,e){if(!this.worker)return;if(this.buffers.length<2)return;let i=this.buffers.shift();if(i.length<8*this.movingBodies.length){let t=i.length;for(;t<8*this.movingBodies.length;)t*=2;let e=this.movingBodies;i=new Float64Array(t),i.fill(NaN);let s=THREE.Vector3.temp(),o=THREE.Quaternion.temp();for(let t=0;t<e.length;t++){let n=8*t;e[t]&&(e[t].object3D.getWorldPosition(s),i[n++]=s.x,i[n++]=s.y,i[n++]=s.z,n++,e[t].object3D.getWorldQuaternion(o),i[n++]=o.x,i[n++]=o.y,i[n++]=o.z,i[n++]=o.w)}}this.worker.postMessage(i,[i.buffer])},onMessage:function(t){if("string"==typeof t.data){let e=s.parse(t.data);switch(e.shift()){case"world":this.command(e)}}else if(t.data instanceof Float64Array)for(this.buffers.push(t.data);this.buffers.length>2;)this.buffers.shift()},command:function(t){switch("number"==typeof t[0]&&t.shift(),t.shift()){case"body":let e=t.shift(),i=this.bodies[e];i&&i.components.body.command(t)}}}),t("./physics/body"),t("./physics/shape"),t("./physics/joint")},{"../libs/cmdCodec":7,"./physics/body":3,"./physics/joint":4,"./physics/shape":5}],3:[function(t,e,i){const s=t("../../libs/cmdCodec");AFRAME.registerComponent("body",{dependencies:["position","rotation","scale"],schema:{type:{type:"string",default:"static"},mass:{type:"number",default:1},belongsTo:{type:"int",default:1},collidesWith:{type:"int",default:1},emitsWith:{type:"int",default:0},sleeping:{type:"boolean",default:!1},autoShape:{type:"boolean",default:!0}},init:function(){let t=this.el.sceneEl.systems.physics.worker,e=this.el.sceneEl.systems.physics.bodies,i=this.el.sceneEl.systems.physics.movingBodies,o=this.el.sceneEl.systems.physics.buffers[0];if(!t)return;this.id=e.indexOf(null),this.id<0&&(this.id=e.length),e[this.id]=this.el,"static"!==this.data.type?(this.mid=i.indexOf(null),this.mid<0&&(this.mid=i.length),i[this.mid]=this.el):this.mid=null;let n={mid:this.mid};if(n.type=this.data.type,n.position=this.el.object3D.getWorldPosition(THREE.Vector3.temp()),n.quaternion=this.el.object3D.getWorldQuaternion(THREE.Quaternion.temp()),null!==this.mid){let t=8*this.mid;o[t++]=n.position.x,o[t++]=n.position.y,o[t++]=n.position.z,o[t++]=this.data.sleeping,o[t++]=n.quaternion.x,o[t++]=n.quaternion.y,o[t++]=n.quaternion.z,o[t++]=n.quaternion.w}if(this.shapes=[],this.sleeping=!0,t.postMessage("world body "+this.id+" create "+s.stringifyParam(n)),setTimeout((()=>{n.position=this.el.object3D.getWorldPosition(THREE.Vector3.temp()),n.quaternion=this.el.object3D.getWorldQuaternion(THREE.Quaternion.temp()),t.postMessage("world body "+this.id+" position = "+s.stringifyParam(n.position)),t.postMessage("world body "+this.id+" quaternion = "+s.stringifyParam(n.quaternion))})),this.data.autoShape&&!this.el.getAttribute("shape"))if(this.el.firstElementChild){let t=this.el.querySelectorAll("a-box, a-sphere, a-cylinder");t&&t.forEach((t=>{t.getAttribute("shape")||t.setAttribute("shape",!0)}))}else this.el.setAttribute("shape",!0)},update:function(t){let e=this.el.sceneEl.systems.physics.worker;e&&(this.data.type!==t.type&&e.postMessage("world body "+this.id+" type = "+s.stringifyParam(this.data.type)),this.data.mass!==t.mass&&e.postMessage("world body "+this.id+" mass = "+s.stringifyParam(this.data.mass)),this.data.belongsTo!==t.belongsTo&&e.postMessage("world body "+this.id+" belongsTo = "+s.stringifyParam(this.data.belongsTo)),this.data.collidesWith!==t.collidesWith&&e.postMessage("world body "+this.id+" collidesWith = "+s.stringifyParam(this.data.collidesWith)),this.data.emitsWith!==t.emitsWith&&e.postMessage("world body "+this.id+" emitsWith = "+s.stringifyParam(this.data.emitsWith)),setTimeout((()=>{e.postMessage("world body "+this.id+" sleeping = "+!!this.data.sleeping)})))},pause:function(){let t=this.el.sceneEl.systems.physics.worker;t&&(t.postMessage("world body "+this.id+" sleeping = true"),this.sleeping=!0)},remove:function(){let t=this.el.sceneEl.systems.physics.worker,e=this.el.sceneEl.systems.physics.bodies,i=this.el.sceneEl.systems.physics.movingBodies;t&&(e[this.id]=null,null!==this.mid&&(i[this.mid]=null),t.postMessage("world body "+this.id+" remove"))},tick:function(){let t=this.el.sceneEl.systems.physics.worker,e=this.el.sceneEl.systems.physics.buffers[0];if(t&&null!==this.mid){let t=8*this.mid;if(e.length<=t)return;if("kinematic"===this.data.type){let i=this.el.object3D.getWorldPosition(THREE.Vector3.temp());e[t++]=i.x,e[t++]=i.y,e[t++]=i.z,this.sleeping=!!e[t++];let s=this.el.object3D.getWorldQuaternion(THREE.Quaternion.temp());e[t++]=s.x,e[t++]=s.y,e[t++]=s.z,e[t++]=s.w}else if(e[t+1]){let i=THREE.Quaternion.temp();this.el.object3D.position.set(e[t++],e[t++],e[t++]),this.el.object3D.parent.worldToLocal(this.el.object3D.position),this.sleeping=!!e[t++],this.el.object3D.getWorldQuaternion(i),this.el.object3D.quaternion.multiply(i.conjugate().normalize()),i.set(e[t++],e[t++],e[t++],e[t++]),this.el.object3D.quaternion.multiply(i.normalize())}}},command:function(t){switch(t.shift()){case"emits":let e=t.shift();switch(e.event){case"collision":let t=this.el.sceneEl.systems.physics.bodies;if(e.body1=t[e.body1],e.body2=t[e.body2],!e.body1||!e.body2)return;e.shape1=e.body1.components.body.shapes[e.shape1],e.shape2=e.body2.components.body.shapes[e.shape2]}this.el.emit(e.event,e)}}})},{"../../libs/cmdCodec":7}],4:[function(t,e,i){const s=t("../../libs/cmdCodec");AFRAME.registerComponent("joint",{multiple:!0,schema:{type:{type:"string",default:"ball"},body1:{type:"selector"},body2:{type:"selector"},pivot1:{type:"vec3",default:{x:0,y:0,z:0}},pivot2:{type:"vec3",default:{x:0,y:0,z:0}},axis1:{type:"vec3",default:{x:0,y:1,z:0}},axis2:{type:"vec3",default:{x:0,y:1,z:0}},min:{type:"number",default:0},max:{type:"number",default:1},collision:{type:"boolean",default:!0}},init:function(){let t=this.el.sceneEl.systems.physics.worker,e=this.el.sceneEl.systems.physics.joints;t&&(this.id=e.indexOf(null),this.id<0&&(this.id=e.length),e[this.id]=this.el,setTimeout((()=>{let e={};e.type=this.data.type,e.body1=this.data.body1?this.data.body1.components.body.id:this.el.components.body.id,e.body2=this.data.body2.components.body.id,e.pivot1=this.data.pivot1,e.pivot2=this.data.pivot2,e.axis1=this.data.axis1,e.axis2=this.data.axis2,e.min=this.data.min,e.max=this.data.max,e.collision=this.data.collision,t.postMessage("world joint "+this.id+" create "+s.stringifyParam(e))})))},update:function(t){this.el.sceneEl.systems.physics.worker},remove:function(){let t=this.el.sceneEl.systems.physics.worker,e=this.el.sceneEl.systems.physics.joints;t&&(e[this.id]=null,t.postMessage("world joint "+this.id+" remove"))}})},{"../../libs/cmdCodec":7}],5:[function(t,e,i){const s=t("../../libs/cmdCodec");AFRAME.registerComponent("shape",{multiple:!0,schema:{},init:function(){for(this.body=this.el;this.body&&!this.body.matches("[body]");)this.body=this.body.parentElement;this.bodyId=this.body.components.body.id;let t=this.el.sceneEl.systems.physics.worker,e=this.body.components.body.shapes;if(!t)return;this.id=e.indexOf(null),this.id<0&&(this.id=e.length),e[this.id]=this.el;let i={};i.position=this.el.object3D.getWorldPosition(THREE.Vector3.temp()),this.body.object3D.worldToLocal(i.position),i.quaternion=this.el.object3D.getWorldQuaternion(THREE.Quaternion.temp());let o=this.body.object3D.getWorldQuaternion(THREE.Quaternion.temp());switch(i.quaternion.multiply(o.conjugate().normalize()).normalize(),i.size=THREE.Vector3.temp().set(1,1,1),this.el.tagName.toLowerCase()){case"a-sphere":i.type="sphere",i.size.multiplyScalar(2*parseFloat(this.el.getAttribute("radius")||1));break;case"a-cylinder":i.type="cylinder",i.size.multiplyScalar(2*parseFloat(this.el.getAttribute("radius")||1)).y=parseFloat(this.el.getAttribute("height")||1);break;case"a-box":i.type="box",i.size.set(parseFloat(this.el.getAttribute("width")||1),parseFloat(this.el.getAttribute("height")||1),parseFloat(this.el.getAttribute("depth")||1))}t.postMessage("world body "+this.bodyId+" shape "+this.id+" create "+s.stringifyParam(i))},update:function(){},remove:function(){let t=this.el.sceneEl.systems.physics.worker,e=this.body.components.body.shapes;t.postMessage("world body "+this.bodyId+" shape "+this.id+" remove"),e[this.id]=null}})},{"../../libs/cmdCodec":7}],6:[function(t,e,i){t("./libs/pools"),t("./libs/copyWorldPosRot"),t("./components/include"),t("./components/physics")},{"./components/include":1,"./components/physics":2,"./libs/copyWorldPosRot":8,"./libs/pools":9}],7:[function(t,e,i){e.exports={parse:function(t){let e=t.split(" "),i=[];for(let t of e)if(t)try{i.push(JSON.parse(t))}catch(e){"="!==t&&i.push(t)}return i},stringifyParam:function(t){return JSON.stringify(t).replaceAll(" ","\\u0020").replaceAll('"_','"')}}},{}],8:[function(t,e,i){AFRAME.AEntity.prototype.copyWorldPosRot=function(t){let e=THREE.Quaternion.temp(),i=t.object3D,s=this.object3D;i&&s&&s.parent&&(i.getWorldPosition(s.position),s.parent.worldToLocal(s.position),s.getWorldQuaternion(e),s.quaternion.multiply(e.conjugate().normalize()),i.getWorldQuaternion(e),s.quaternion.multiply(e.normalize()))}},{}],9:[function(t,e,i){function s(t){t._pool=[],t._inUse=[],t.temp=function(){let e=t._pool.pop()||new t;return t._inUse.push(e),t._gc||(t._gc=setTimeout(t._recycle)),e},t._recycle=function(){for(;t._inUse.length;)t._pool.push(t._inUse.pop());t._gc=!1}}s(THREE.Vector2),s(THREE.Vector3),s(THREE.Quaternion),s(THREE.Matrix3),s(THREE.Matrix4)},{}]},{},[6]);
