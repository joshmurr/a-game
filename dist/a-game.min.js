!function t(e,i,s){function o(r,a){if(!i[r]){if(!e[r]){var h="function"==typeof require&&require;if(!a&&h)return h(r,!0);if(n)return n(r,!0);var l=new Error("Cannot find module '"+r+"'");throw l.code="MODULE_NOT_FOUND",l}var c=i[r]={exports:{}};e[r][0].call(c.exports,(function(t){return o(e[r][1][t]||t)}),c,c.exports,t,e,i,s)}return i[r].exports}for(var n="function"==typeof require&&require,r=0;r<s.length;r++)o(s[r]);return o}({1:[function(t,e,i){e.exports={name:"a-game",title:"A-Game",version:"0.3.1",description:"game components for A-Frame",main:"index.js",scripts:{prepare:"npm run build",build:'foreach -g src/*.js -x "browserify #{path} -o dist/#{name}.js" && npm run minify',watch:'foreach -g src/*.js -C -x "watchify #{path} -d -o dist/#{name}.js"',minify:'touch dist/foo.min.js && rm dist/*.min.js && foreach -g dist/*.js -C -x "minify #{path} > dist/#{name}.min.js"',bump:"npm version patch --no-git-tag-version",gitadd:"git add package*.json dist/"},"pre-commit":["bump","build","gitadd"],keywords:["aframe","webvr","webxr","gamedev"],author:"poeticAndroid",license:"MIT",devDependencies:{browserify:"^17.0.0","foreach-cli":"^1.8.1",minify:"^7.0.1","pre-commit":"^1.2.2",watchify:"^4.0.0"}}},{}],2:[function(t,e,i){t("./libs/pools"),t("./libs/copyWorldPosRot"),t("./libs/ensureElement"),t("./libs/touchGestures"),setTimeout((()=>{document.body.addEventListener("swipeup",(t=>{document.body.requestFullscreen()}))})),t("./components/include"),t("./components/physics"),t("./components/injectplayer"),t("./components/locomotion"),t("./components/grabbing"),t("./primitives/a-main"),t("./primitives/a-player"),t("./primitives/a-hand");const s=t("../package");console.log(`${s.title} Version ${s.version} by ${s.author}`)},{"../package":1,"./components/grabbing":3,"./components/include":5,"./components/injectplayer":6,"./components/locomotion":7,"./components/physics":11,"./libs/copyWorldPosRot":16,"./libs/ensureElement":17,"./libs/pools":18,"./libs/touchGestures":19,"./primitives/a-hand":20,"./primitives/a-main":21,"./primitives/a-player":22}],3:[function(t,e,i){AFRAME.registerComponent("grabbing",{schema:{hideOnGrab:{type:"boolean",default:!1},grabDistance:{type:"number",default:1}},init:function(){this._enableHands=this._enableHands.bind(this),this._onKeyDown=this._onKeyDown.bind(this),this._onMouseDown=this._onMouseDown.bind(this),this._onMouseUp=this._onMouseUp.bind(this),this._onGripDown=this._onGripDown.bind(this),this._onGripUp=this._onGripUp.bind(this),this._onTriggerDown=this._onTriggerDown.bind(this),this._onTriggerUp=this._onTriggerUp.bind(this),this._onButtonDown=this._onButtonDown.bind(this),this._onButtonUp=this._onButtonUp.bind(this),this._onTouchTap=this._onTouchTap.bind(this),this._onTouchHold=this._onTouchHold.bind(this),this._hands=["head","left","right"],this._head={},this._left={},this._right={},this._head.hand=this.el.querySelector("a-camera"),this._left.hand=this.el.querySelector('a-hand[side="left"]'),this._right.hand=this.el.querySelector('a-hand[side="right"]'),this._head.glove=this._head.hand,this._left.glove=this.el.querySelector(".left.glove")||this._left.hand,this._right.glove=this.el.querySelector(".right.glove")||this._right.hand,this._left.glove.setAttribute("visible",!1),this._right.glove.setAttribute("visible",!1);for(let t of this._hands){this["_"+t].hand.addEventListener("buttonchanged",this._enableHands)}this._head.glove.ensure(".hitbox","a-sphere",{class:"hitbox",visible:!1,radius:.5}),this._head.glove.setAttribute("body","type:kinematic;"),this._head.ray=this._head.glove.ensure(".grabbing-ray","a-entity",{class:"grabbing-ray",position:"0 -0.125 0",raycaster:{objects:"[wall], [grabbable]",autoRefresh:!1}}),this._head.anchor=this._head.ray.ensure(".grabbing-anchor","a-entity",{class:"grabbing-anchor",visible:"false",body:"type:kinematic;autoShape:false;"})},update:function(t){for(let t of this._hands){let e="_"+t;this[e].ray&&this[e].ray.setAttribute("raycaster","far",this.data.grabDistance+("head"===t?1:.1875))}},play:function(){document.addEventListener("keydown",this._onKeyDown),this.el.sceneEl.canvas.addEventListener("mousedown",this._onMouseDown),this.el.sceneEl.canvas.addEventListener("mouseup",this._onMouseUp);for(let t of[this._left.hand,this._right.hand])t.addEventListener("gripdown",this._onGripDown),t.addEventListener("gripup",this._onGripUp),t.addEventListener("triggerdown",this._onTriggerDown),t.addEventListener("triggerup",this._onTriggerUp),t.addEventListener("buttondown",this._onButtonDown),t.addEventListener("buttonup",this._onButtonUp);this.el.sceneEl.canvas.addEventListener("tap",this._onTouchTap),this.el.sceneEl.canvas.addEventListener("hold",this._onTouchHold)},pause:function(){document.removeEventListener("keydown",this._onKeyDown),this.el.sceneEl.canvas.removeEventListener("mousedown",this._onMouseDown),this.el.sceneEl.canvas.removeEventListener("mouseup",this._onMouseUp);for(let t of[this._left.hand,this._right.hand])t.removeEventListener("gripdown",this._onGripDown),t.removeEventListener("gripup",this._onGripUp),t.removeEventListener("triggerdown",this._onTriggerDown),t.removeEventListener("triggerup",this._onTriggerUp),t.removeEventListener("buttondown",this._onButtonDown),t.removeEventListener("buttonup",this._onButtonUp);this.el.sceneEl.canvas.removeEventListener("tap",this._onTouchTap),this.el.sceneEl.canvas.removeEventListener("hold",this._onTouchHold)},remove:function(){},tick:function(t,e){for(let t of this._hands){let e="_"+t;this[e].grabbed?this[e].isPhysical||this[e].grabbed.copyWorldPosRot(this[e].anchor):this[e].ray&&(ray=this[e].ray.components.raycaster,ray.refreshObjects(),hit=ray.intersections[0],hit&&null!=hit.object.el.getAttribute("grabbable")?this[e]._lastHit!==hit.object.el&&(this[e]._lastHit&&this.emit("unreach",this[e].glove,this[e]._lastHit),this[e]._lastHit=hit.object.el,this.emit("reach",this[e].glove,this[e]._lastHit)):(this[e]._lastHit&&this.emit("unreach",this[e].glove,this[e]._lastHit),this[e]._lastHit=null))}},toggleGrab:function(t="head"){this["_"+t].grabbed?this.drop(t):this.grab(t)},grab:function(t="head"){let e="_"+t;if(this[e].ray&&(this[e].grabbed&&this.drop(t),ray=this[e].ray.components.raycaster,ray.refreshObjects(),hit=ray.intersections[0],hit&&null!=hit.object.el.getAttribute("grabbable"))){this.dropObject(hit.object.el),this[e].grabbed=hit.object.el,this[e].anchor.copyWorldPosRot(this[e].grabbed),null!=this[e].grabbed.getAttribute("body")?(this[e].anchor.setAttribute("joint__1",{body2:this[e].grabbed,pivot1:"-1 -1 0",pivot2:"-1 -1 0"}),this[e].anchor.setAttribute("joint__2",{body2:this[e].grabbed,pivot1:"1 -1 0",pivot2:"1 -1 0"}),this[e].anchor.setAttribute("joint__3",{body2:this[e].grabbed,pivot1:"0 1 0",pivot2:"0 1 0"}),this[e].isPhysical=!0):this[e].isPhysical=!1,this[e].anchor.removeAttribute("animation");let i=hit.distance;i-="head"===t?.5:.0625,this[e].anchor.setAttribute("animation",{property:"object3D.position.z",to:this[e].anchor.object3D.position.z+i,dur:256}),this.data.hideOnGrab&&this[e].glove.setAttribute("visible",!1),this[e].glove.setAttribute("body","collidesWith",0),this.emit("grab",this[e].glove,this[e].grabbed)}},drop:function(t="head"){let e="_"+t;this[e].anchor.removeAttribute("joint__1"),this[e].anchor.removeAttribute("joint__2"),this[e].anchor.removeAttribute("joint__3"),this[e].anchor.removeAttribute("animation"),this[e].glove.setAttribute("visible",!0),this[e].glove.setAttribute("body","collidesWith",1),this.emit("drop",this[e].glove,this[e].grabbed),this[e].grabbed=null},dropObject:function(t){for(let e of this._hands){this["_"+e].grabbed===t&&this.drop(e)}},use:function(t="head",e=0){this.useDown(t,e),setTimeout((()=>{this.useUp(t,e)}),32)},useDown:function(t="head",e=0){let i="_"+t;if(!this[i].grabbed)return this.grab(t);this.emit("usedown",this[i].glove,this[i].grabbed,{button:e})},useUp:function(t="head",e=0){let i="_"+t;this.emit("useup",this[i].glove,this[i].grabbed,{button:e})},emit:function(t,e,i,s={}){s.grabbing=this.el,s.grabbedElement=i,s.gloveElement=e;for(let t of this._hands)this["_"+t].hand===e&&(s.hand=t);e.emit(t,s),i&&i.emit(t,s)},_enableHands:function(){for(let t of this._hands){let e="_"+t;this[e].hand.removeEventListener("buttonchanged",this._enableHands);let i=.0625;this[e].glove.ensure(".hitbox","a-box",{class:"hitbox",visible:!1,position:"0 0 0.03125",width:i/2,height:i,depth:2*i}),this[e].glove.setAttribute("body","type:kinematic;")}this._left.ray=this._left.glove.ensure(".grabbing-ray","a-entity",{class:"grabbing-ray",position:"-0.0625 0 0.0625",rotation:"0 -45 0",raycaster:{objects:"[wall], [grabbable]",autoRefresh:!1}}),this._right.ray=this._right.glove.ensure(".grabbing-ray","a-entity",{class:"grabbing-ray",position:"0.0625 0 0.0625",rotation:"0 45 0",raycaster:{objects:"[wall], [grabbable]",autoRefresh:!1}}),this._left.anchor=this._left.ray.ensure(".grabbing-anchor","a-entity",{class:"grabbing-anchor",visible:"false",body:"type:kinematic;autoShape:false;"}),this._right.anchor=this._right.ray.ensure(".grabbing-anchor","a-entity",{class:"grabbing-anchor",visible:"false",body:"type:kinematic;autoShape:false;"}),this.update()},_onKeyDown:function(t){"e"===t.key&&this.toggleGrab()},_onMouseDown:function(t){let e=t.button;this.useDown("head",e?e%2?e+1:e-1:e)},_onMouseUp:function(t){let e=t.button;this.useUp("head",e?e%2?e+1:e-1:e)},_onTouchTap:function(t){this.use()},_onTouchHold:function(t){this.toggleGrab()},_onGripDown:function(t){this.grab(t.target.getAttribute("side"))},_onGripUp:function(t){this.drop(t.target.getAttribute("side"))},_onTriggerDown:function(t){this.useDown(t.target.getAttribute("side"))},_onTriggerUp:function(t){this.useUp(t.target.getAttribute("side"))},_onButtonDown:function(t){let e=t.detail.id-3;if(e<1)return;let i="right";t.target==this._left.hand&&(i="left"),this.useDown(i,e)},_onButtonUp:function(t){let e=t.detail.id-3;if(e<1)return;let i="right";t.target==this._left.hand&&(i="left"),this.useUp(i,e)}}),t("./grabbing/grabbable")},{"./grabbing/grabbable":4}],4:[function(t,e,i){AFRAME.registerComponent("grabbable",{schema:{freeOrientation:{type:"boolean",default:!0},physics:{type:"boolean",default:!0}},init:function(){this.data.physics&&!this.el.getAttribute("body")&&this.el.setAttribute("body","type:dynamic;")}})},{}],5:[function(t,e,i){AFRAME.registerComponent("include",{schema:{type:"string"},init:async function(){if(this.data&&!this.el.sceneEl._including_){this.el.sceneEl._including_=!0;let t=this.el.outerHTML,e=t.indexOf(" "),i=t.indexOf(" include="),s=t.substr(e,i-e);e=t.indexOf('"',i+10)+1,i=t.indexOf(">"),s+=t.substr(e,i-e);let o=await fetch(this.data);o.status>=200&&o.status<300?this.el.outerHTML=await(await o.text()).replace(">"," >").replace(" "," "+s+" "):this.el.removeAttribute("include"),this.el.sceneEl._including_=!1;let n=this.el.sceneEl.querySelector("[include]");n&&n.components&&n.components.include&&n.components.include.init()}}})},{}],6:[function(t,e,i){AFRAME.registerComponent("injectplayer",{init:function(){this.el.ensure("a-camera","a-camera",{"look-controls":{pointerLockEnabled:!0,touchEnabled:!1},"wasd-controls":{enabled:!1}}),this.el.ensure('a-hand[side="left"]',"a-hand",{side:"left"}),this.el.ensure('a-hand[side="right"]',"a-hand",{side:"right"})}})},{}],7:[function(t,e,s){AFRAME.registerComponent("locomotion",{dependencies:["position","injectplayer"],schema:{speed:{type:"number",default:4},rotationSpeed:{type:"number",default:1},teleportDistance:{type:"number",default:5},jumpForce:{type:"number",default:0},gravity:{type:"number",default:10},godMode:{type:"boolean",default:!1}},init:function(){this._onKeyDown=this._onKeyDown.bind(this),this._onKeyUp=this._onKeyUp.bind(this),this._onAxisMove=this._onAxisMove.bind(this),this._onButtonChanged=this._onButtonChanged.bind(this),this._onTouchStart=this._onTouchStart.bind(this),this._onTouchMove=this._onTouchMove.bind(this),this._onTouchEnd=this._onTouchEnd.bind(this),this._onEnterVR=this._onEnterVR.bind(this),this._onExitVR=this._onExitVR.bind(this),this._keysDown={},this._axes=[0,0,0,0],this._leftTouchCenter=new THREE.Vector2,this._leftTouchDir=new THREE.Vector2,this._rightTouchCenter=new THREE.Vector2,this._rightTouchDir=new THREE.Vector2,this._teleporting=!0,this._flyDir=1,this._bumpOverload=0,this._vertVelocity=1,this.currentFloorPosition=new THREE.Vector3,this.centerPos=new THREE.Vector3,this.headPos=new THREE.Vector3,this.headDir=new THREE.Vector3,this.feetPos=new THREE.Vector3,this._config=JSON.parse(localStorage.getItem("a-game.locomotion"))||{quantizeMovement:!1,quantizeRotation:!1,quantizeMovementVR:!!this.el.sceneEl.isMobile,quantizeRotationVR:!0},this.el.sceneEl.is("vr-mode")?this._onEnterVR():this._onExitVR(),this._camera=this.el.querySelector("a-camera"),this._leftHand=this.el.querySelector('a-hand[side="left"]'),this._rightHand=this.el.querySelector('a-hand[side="right"]'),this._legs=this.el.sceneEl.ensure(".legs","a-entity",{class:"legs",position:"0 0.5 0",raycaster:{autoRefresh:!1,objects:"[floor]",direction:"0 -1 0",far:.625}}),this._legBumper=this.el.sceneEl.ensure(".leg-bumper","a-entity",{class:"leg-bumper",position:"0 0.5 0",raycaster:{autoRefresh:!1,objects:"[wall]"}}),this._headBumper=this.el.sceneEl.ensure(".head-bumper","a-entity",{class:"head-bumper",position:"0 0.5 0",raycaster:{autoRefresh:!1,objects:"[wall]"}}),this._teleportBeam=this._camera.ensure(".teleport-ray","a-entity",{class:"teleport-ray",raycaster:{autoRefresh:!1,objects:"[wall]"}}),this._teleportCursor=this.el.ensure(".teleport-cursor","a-cylinder",{class:"teleport-cursor",radius:.5,height:.0625,material:"opacity:0.5;"})},update:function(t){this._godMode=this.data.godMode},play:function(){document.addEventListener("keydown",this._onKeyDown),document.addEventListener("keyup",this._onKeyUp),this._leftHand.addEventListener("axismove",this._onAxisMove),this._rightHand.addEventListener("axismove",this._onAxisMove),this._leftHand.addEventListener("buttonchanged",this._onButtonChanged),this._rightHand.addEventListener("buttonchanged",this._onButtonChanged),this.el.sceneEl.canvas.addEventListener("touchstart",this._onTouchStart),this.el.sceneEl.canvas.addEventListener("touchmove",this._onTouchMove),this.el.sceneEl.canvas.addEventListener("touchend",this._onTouchEnd),this.el.sceneEl.addEventListener("enter-vr",this._onEnterVR),this.el.sceneEl.addEventListener("exit-vr",this._onExitVR)},pause:function(){document.removeEventListener("keydown",this._onKeyDown),document.removeEventListener("keyup",this._onKeyUp),this._leftHand.removeEventListener("axismove",this._onAxisMove),this._rightHand.removeEventListener("axismove",this._onAxisMove),this._leftHand.removeEventListener("buttonchanged",this._onButtonChanged),this._rightHand.removeEventListener("buttonchanged",this._onButtonChanged),this.el.sceneEl.canvas.removeEventListener("touchstart",this._onTouchStart),this.el.sceneEl.canvas.removeEventListener("touchmove",this._onTouchMove),this.el.sceneEl.canvas.removeEventListener("touchend",this._onTouchEnd),this.el.sceneEl.removeEventListener("enter-vr",this._onEnterVR),this.el.sceneEl.removeEventListener("exit-vr",this._onExitVR)},remove:function(){this.el.sceneEl.removeChild(this._legs),this.el.sceneEl.removeChild(this._legBumper),this.el.sceneEl.removeChild(this._headBumper)},tick:function(t,e){e/=1e3,this.el.object3D.getWorldPosition(this.centerPos),this.headPos.copy(this._camera.object3D.position),this._camera.object3D.parent.localToWorld(this.headPos),this.headDir.set(0,0,-1).applyQuaternion(this._camera.object3D.quaternion).applyQuaternion(this.el.object3D.getWorldQuaternion(THREE.Quaternion.temp())),this._legs.object3D.getWorldPosition(this.feetPos),this.feetPos.y-=.5,this._applyToggles(e),this._applyMoveStick(e),this._applyAuxStick(e);let i=THREE.Vector3.temp().copy(this.headPos).sub(this.feetPos);if(i.y=0,i.length()>.5&&(i.multiplyScalar(.1),this._legs.object3D.position.add(i),this.feetPos.add(i)),!this._godMode&&!this._caution){let t=this._legs.components.raycaster;t.refreshObjects();let i=t.intersections[0];if(i&&this._vertVelocity<=0){if(this._vertVelocity=0,this.currentFloor===i.object.el){let t=THREE.Vector3.temp();t.copy(this.currentFloor.object3D.position).sub(this.currentFloorPosition),this._move(t),t.y=0,this._legs.object3D.position.add(t)}else this.currentFloor&&this.currentFloor.emit("playerleave"),i.object.el.emit("playerenter");this._move(THREE.Vector3.temp().set(0,.5-i.distance,0)),this.currentFloor=i.object.el,this.currentFloorPosition.copy(this.currentFloor.object3D.position)}else this.currentFloor&&this.currentFloor.emit("playerleave"),this._vertVelocity-=this.data.gravity*e,this._move(THREE.Vector3.temp().set(0,Math.max(-.5,this._vertVelocity*e),0)),this.currentFloor=null}if(this._godMode)this._legBumper.object3D.position.copy(this._legs.object3D.position),this._headBumper.object3D.position.copy(this._legs.object3D.position);else if(this._bumpOverload>4||Math.abs(this.headPos.y-this.feetPos.y)>3)this.feetPos.y=this.centerPos.y,this._legs.object3D.position.y=this.feetPos.y+.5,this.teleport(this._legBumper.object3D.position,!0),this._bumpOverload&&this._bumpOverload--;else{let t=THREE.Vector3.temp();t.copy(this.feetPos).y+=.5,this._bump(t,this._legBumper),t.copy(this.headPos),this._bump(t,this._headBumper)}},teleport:function(t,e){let i=THREE.Vector3.temp();i.copy(t).sub(this.feetPos),this._move(i),this._legs.object3D.position.x=this.feetPos.x=this.headPos.x,this._legs.object3D.position.z=this.feetPos.z=this.headPos.z,this._caution=8,e&&(this._legBumper.object3D.position.copy(this._legs.object3D.position),this._headBumper.object3D.position.copy(this._legs.object3D.position))},toggleCrouch:function(t){let e,i=this.headPos.y-this.feetPos.y;Math.abs(this.centerPos.y-this.feetPos.y)>.03125?e=this.feetPos.y-this.centerPos.y:t||(e=i>1?-1:1),this.el.removeAttribute("animation"),e&&this.el.setAttribute("animation",{property:"object3D.position.y",to:this.el.object3D.position.y+e,dur:256})},_move:function(t){this.el.object3D.position.add(t),this.centerPos.add(t),this.headPos.add(t),this._legs.object3D.position.y+=t.y,this.feetPos.y+=t.y},_bump:function(t,e){let i=THREE.Matrix3.temp(),s=THREE.Vector3.temp();s.copy(t),s.sub(e.object3D.position);let o=s.length();if(o)if(e.setAttribute("raycaster","far",o+.125),e.setAttribute("raycaster","direction",s.normalize()),ray=e.components.raycaster,ray.refreshObjects(),hit=ray.intersections[0],hit){i.getNormalMatrix(hit.object.el.object3D.matrixWorld),s.copy(hit.face.normal).applyMatrix3(i).normalize().multiplyScalar(.25+o/2);let t=this._legs.object3D.position.y;this._move(s),this._legs.object3D.position.y=t,this._caution=4,this._bumpOverload++,this._vertVelocity=Math.min(0,this._vertVelocity)}else this._caution?this._caution--:(this._bumpOverload&&this._bumpOverload--,e.object3D.position.lerp(t,.25))},_callMoveStick(){let t=THREE.Vector2.temp().set(0,0),e=THREE.Vector2.temp();for(e.set(0,0),this._keysDown.a&&e.x--,this._keysDown.d&&e.x++,(this._keysDown.w||this._keysDown.ArrowUp)&&e.y--,(this._keysDown.s||this._keysDown.ArrowDown)&&e.y++,e.length()>t.length()&&t.copy(e),e.set(this._axes[0],this._axes[1]),e.length()>t.length()&&t.copy(e),e.copy(this._leftTouchDir),e.length()>t.length()&&t.copy(e),i=0,len=navigator.getGamepads().length;i<len;i++)gamepad=navigator.getGamepads()[i],gamepad&&(e.set(Math.abs(gamepad.axes[0])>.25?gamepad.axes[0]:0,Math.abs(gamepad.axes[1])>.25?gamepad.axes[1]:0),e.length()>t.length()&&t.copy(e));return t.length()>1&&t.normalize(),t},_applyMoveStick:function(t){let e=this._callMoveStick();e.multiplyScalar(this.data.speed),e.multiplyScalar(t);let i=THREE.Vector2.temp().set(this.headDir.z,-this.headDir.x).angle()-Math.PI,s=Math.cos(i)*e.x-Math.sin(i)*e.y,o=Math.sin(i)*e.x+Math.cos(i)*e.y,n=THREE.Vector3.temp().set(s,0,o);this.quantizeMovement&&(this._quantTime=this._quantTime||0,this._quantDelta=this._quantDelta||new THREE.Vector3,this._quantTime+=t,this._quantDelta.add(n),this._quantTime>.25?(this._quantTime-=.25,n.copy(this._quantDelta),this._quantDelta.set(0,0,0)):n.set(0,0,0)),this._move(n)},_callAuxStick(){let t=THREE.Vector2.temp().set(0,0),e=THREE.Vector2.temp();for(e.set(0,0),this._keysDown.ArrowLeft&&e.x--,this._keysDown.ArrowRight&&e.x++,this._keysDown[" "]&&e.y--,this._keysDown.Control&&e.y++,e.length()>t.length()&&t.copy(e),e.set(this._axes[2],this._axes[3]),e.length()>t.length()&&t.copy(e),e.copy(this._rightTouchDir),e.length()>t.length()&&t.copy(e),i=0,len=navigator.getGamepads().length;i<len;i++)gamepad=navigator.getGamepads()[i],gamepad&&(e.set(Math.abs(gamepad.axes[2])>.25?gamepad.axes[2]:0,Math.abs(gamepad.axes[3])>.25?gamepad.axes[3]:0),e.length()>t.length()&&t.copy(e));return t.length()>1&&t.normalize(),t},_applyAuxStick:function(t){let e=this._callAuxStick(),i=0;if(this.quantizeRotation?Math.round(e.x)?this._rotating||(this._rotating=!0,i=-Math.round(e.x)*Math.PI/4):this._rotating=!1:i=-e.x*this.data.rotationSpeed*t,i){let t=THREE.Vector2.temp(),e=THREE.Vector2.temp(),s=THREE.Vector3.temp();t.set(this.feetPos.x,this.feetPos.z),e.set(this.centerPos.x,this.centerPos.z),t.rotateAround(e,-i),s.set(this.feetPos.x-t.x,0,this.feetPos.z-t.y),this.el.object3D.rotateY(i),this.el.object3D.position.add(s),this.centerPos.add(s)}if(Math.round(e.y)>0?this._godMode?(this.el.object3D.position.y+=e.y*this.data.speed*t*this._flyDir,this._legs.object3D.position.y+=e.y*this.data.speed*t*this._flyDir,this._crouching=!0):this._crouching||(this._crouching=!0,this.toggleCrouch()):(this._crouching&&(this._flyDir*=-1),this._crouching=!1),Math.round(e.y)<0){!this._teleporting&&this.data.teleportDistance&&(this._teleportCursor.setAttribute("visible",!0),this._teleporting=!0);let t=THREE.Quaternion.temp();if(this._teleportCursor.object3D.getWorldQuaternion(t),this._teleportCursor.object3D.quaternion.multiply(t.conjugate().normalize()).multiply(t.copy(this.el.object3D.quaternion).multiply(this._camera.object3D.quaternion)),this._teleportCursor.object3D.quaternion.x=0,this._teleportCursor.object3D.quaternion.z=0,this._teleportCursor.object3D.quaternion.normalize(),ray=this._teleportBeam.components.raycaster,ray.refreshObjects(),hit=ray.intersections[0],hit&&null!=hit.object.el.getAttribute("floor")){let e=THREE.Vector3.temp(),i=THREE.Vector3.temp(),s=THREE.Matrix3.temp();i.copy(hit.point).sub(this.feetPos),i.y>1.5&&i.multiplyScalar(0),i.length()>this.data.teleportDistance&&i.normalize().multiplyScalar(this.data.teleportDistance),i.add(this.feetPos),this._teleportCursor.object3D.position.copy(i),this._teleportCursor.object3D.parent.worldToLocal(this._teleportCursor.object3D.position),s.getNormalMatrix(hit.object.el.object3D.matrixWorld),i.copy(hit.face.normal).applyMatrix3(s).normalize(),i.applyQuaternion(t.copy(this.el.object3D.quaternion).conjugate()),e.set(0,1,0),t.setFromUnitVectors(e,i),this._teleportCursor.object3D.quaternion.premultiply(t)}else this._teleportCursor.object3D.position.copy(this.feetPos),this._teleportCursor.object3D.parent.worldToLocal(this._teleportCursor.object3D.position);this.currentFloor&&!this._jumping&&(this._vertVelocity=this.data.jumpForce,this._jumping=!0)}else if(this._teleporting){let t=THREE.Vector3.temp();this._teleportCursor.object3D.getWorldPosition(t),this.teleport(t),this._teleportCursor.setAttribute("visible",!1),this._teleportCursor.setAttribute("position","0 0 0"),this._teleporting=!1}else this._jumping&&(this._jumping=!1)},_callToggles(){let t=0;for(this._keysDown.h&&(t|=1),this._keysDown.g&&(t|=2),this._vrRightClick&&(t|=1),this._vrLeftClick&&(t|=2),i=0,len=navigator.getGamepads().length;i<len;i++)gamepad=navigator.getGamepads()[i],gamepad&&(gamepad.buttons[11].pressed&&(t|=1),gamepad.buttons[10].pressed&&(t|=2));return t},_applyToggles:function(){let t=this._callToggles();t?(this._toggling||(1&t&&(this.quantizeRotation=!this.quantizeRotation),2&t&&(this.data.godMode?this._godMode=!this._godMode:this.quantizeMovement=!this.quantizeMovement),this.isVR?(this._config.quantizeMovementVR=this.quantizeMovement,this._config.quantizeRotationVR=this.quantizeRotation):(this._config.quantizeMovement=this.quantizeMovement,this._config.quantizeRotation=this.quantizeRotation),localStorage.setItem("a-game.locomotion",JSON.stringify(this._config))),this._toggling=!0):this._toggling=!1},_onKeyDown(t){this._keysDown[t.key]=!0},_onKeyUp(t){this._keysDown[t.key]=!1},_onAxisMove(t){"left"===t.srcElement.getAttribute("hand-controls").hand?(this._axes[0]=t.detail.axis[2],this._axes[1]=t.detail.axis[3]):(this._axes[2]=t.detail.axis[2],this._axes[3]=t.detail.axis[3]),this._handEnabled||(this._teleportBeam.parentElement.removeChild(this._teleportBeam),this._teleportBeam=this._rightHand.ensure(".teleportBeam","a-entity",{class:"teleportBeam",raycaster:{autoRefresh:!1,objects:"[wall]"}}),this._handEnabled=!0)},_onButtonChanged:function(t){"left"===t.srcElement.getAttribute("hand-controls").hand?3==t.detail.id&&(this._vrLeftClick=t.detail.state.pressed):3==t.detail.id&&(this._vrRightClick=t.detail.state.pressed)},_onTouchStart:function(t){let e=this.el.sceneEl.canvas.clientWidth;for(let i=0;i<t.changedTouches.length;i++){let s=t.changedTouches[i];s.clientX<e/2&&(this._leftTouchId=s.identifier,this._leftTouchCenter.set(s.clientX,s.clientY)),s.clientX>e/2&&(this._rightTouchId=s.identifier,this._rightTouchCenter.set(s.clientX,s.clientY))}t.preventDefault()},_onTouchMove:function(t){for(let e=0;e<t.changedTouches.length;e++){let i=t.changedTouches[e],s=null,o=null;this._leftTouchId===i.identifier&&(s=this._leftTouchCenter,o=this._leftTouchDir),this._rightTouchId===i.identifier&&(s=this._rightTouchCenter,o=this._rightTouchDir),o&&(o.set(i.clientX,i.clientY),o.sub(s),o.length()>32&&(o.multiplyScalar((o.length()-32)/o.length()),s.add(o),o.multiplyScalar(32/o.length())),o.divideScalar(32))}t.preventDefault()},_onTouchEnd:function(t){for(let e=0;e<t.changedTouches.length;e++){let i=t.changedTouches[e];this._leftTouchId===i.identifier&&(this._leftTouchId=null,this._leftTouchDir.set(0,0)),this._rightTouchId===i.identifier&&(this._rightTouchId=null,this._rightTouchDir.set(0,0))}},_onEnterVR:function(t){this.isVR=!0,this.quantizeMovement=this._config.quantizeMovementVR,this.quantizeRotation=this._config.quantizeRotationVR},_onExitVR:function(t){this.isVR=!1,this.quantizeMovement=this._config.quantizeMovement,this.quantizeRotation=this._config.quantizeRotation}}),t("./locomotion/floor"),t("./locomotion/wall"),t("./locomotion/start")},{"./locomotion/floor":8,"./locomotion/start":9,"./locomotion/wall":10}],8:[function(t,e,i){AFRAME.registerComponent("floor",{schema:{physics:{type:"boolean",default:!0}},update:function(){this.el.setAttribute("wall",this.data)}})},{}],9:[function(t,e,i){AFRAME.registerComponent("start",{init:function(){let t=this.el.sceneEl.querySelector("[locomotion]").components.locomotion;if(!t)return setTimeout((()=>{this.init()}),256);let e=new THREE.Vector3;setTimeout((()=>{this.el.object3D.getWorldPosition(e),t.teleport(e,!0),setTimeout((()=>{t.toggleCrouch(!0)}),256)}),256)}})},{}],10:[function(t,e,i){AFRAME.registerComponent("wall",{schema:{physics:{type:"boolean",default:!0}},update:function(){this.data.physics&&!this.el.getAttribute("body")&&this.el.setAttribute("body","type:static")}})},{}],11:[function(t,e,i){const s=t("../libs/cmdCodec"),o=t("../../package");AFRAME.registerSystem("physics",{schema:{workerUrl:{type:"string",default:`https://cdn.jsdelivr.net/gh/poeticAndroid/a-game@v${o.version}/dist/cannonWorker.min.js`},gravity:{type:"vec3",default:{x:0,y:-10,z:0}},debug:{type:"boolean",default:!1}},update:function(){if(this.data.workerUrl){if(!this.worker){let t=`importScripts(${JSON.stringify(this.data.workerUrl)})`;this.worker=new Worker(`data:text/javascript;base64,${btoa(t)}`),this.worker.postMessage("log "+s.stringifyParam("Physics worker ready!")),this.worker.addEventListener("message",this.onMessage.bind(this))}this.bodies=this.bodies||[],this.movingBodies=this.movingBodies||[],this.joints=this.joints||[],this.buffers=[new Float64Array(8),new Float64Array(8)],this.worker.postMessage("world gravity = "+s.stringifyParam(this.data.gravity)),this._debug=this.data.debug}else this.remove()},remove:function(){this.worker&&this.worker.terminate(),this.worker=null,this.bodies=[],this.movingBodies=[]},tick:function(t,e){if(!this.worker)return;if(this.buffers.length<2)return;let i=this.buffers.shift();if(i.length<8*this.movingBodies.length){let t=i.length;for(;t<8*this.movingBodies.length;)t*=2;let e=this.movingBodies;i=new Float64Array(t),i.fill(NaN);let s=THREE.Vector3.temp(),o=THREE.Quaternion.temp();for(let t=0;t<e.length;t++){let n=8*t;e[t]&&(e[t].object3D.getWorldPosition(s),i[n++]=s.x,i[n++]=s.y,i[n++]=s.z,n++,e[t].object3D.getWorldQuaternion(o),i[n++]=o.x,i[n++]=o.y,i[n++]=o.z,i[n++]=o.w)}}this.worker.postMessage(i,[i.buffer])},onMessage:function(t){if("string"==typeof t.data){let e=s.parse(t.data);switch(e.shift()){case"world":this.command(e)}}else if(t.data instanceof Float64Array)for(this.buffers.push(t.data);this.buffers.length>2;)this.buffers.shift()},command:function(t){switch("number"==typeof t[0]&&t.shift(),t.shift()){case"body":let e=t.shift(),i=this.bodies[e];i&&i.components.body.command(t)}}}),t("./physics/body"),t("./physics/shape"),t("./physics/joint")},{"../../package":1,"../libs/cmdCodec":15,"./physics/body":12,"./physics/joint":13,"./physics/shape":14}],12:[function(t,e,i){const s=t("../../libs/cmdCodec");AFRAME.registerComponent("body",{dependencies:["position","rotation","scale"],schema:{type:{type:"string",default:"static"},mass:{type:"number",default:1},belongsTo:{type:"int",default:1},collidesWith:{type:"int",default:1},emitsWith:{type:"int",default:0},sleeping:{type:"boolean",default:!1},autoShape:{type:"boolean",default:!0}},init:function(){let t=this.el.sceneEl.systems.physics.worker,e=this.el.sceneEl.systems.physics.bodies,i=this.el.sceneEl.systems.physics.movingBodies,o=this.el.sceneEl.systems.physics.buffers[0];if(!t)return;this.id=e.indexOf(null),this.id<0&&(this.id=e.length),e[this.id]=this.el,"static"!==this.data.type?(this.mid=i.indexOf(null),this.mid<0&&(this.mid=i.length),i[this.mid]=this.el):this.mid=null;let n={mid:this.mid};if(n.type=this.data.type,n.position=this.el.object3D.getWorldPosition(THREE.Vector3.temp()),n.quaternion=this.el.object3D.getWorldQuaternion(THREE.Quaternion.temp()),null!==this.mid){let t=8*this.mid;o[t++]=n.position.x,o[t++]=n.position.y,o[t++]=n.position.z,o[t++]=this.data.sleeping,o[t++]=n.quaternion.x,o[t++]=n.quaternion.y,o[t++]=n.quaternion.z,o[t++]=n.quaternion.w}if(this.shapes=[],this.sleeping=!0,t.postMessage("world body "+this.id+" create "+s.stringifyParam(n)),setTimeout((()=>{n.position=this.el.object3D.getWorldPosition(THREE.Vector3.temp()),n.quaternion=this.el.object3D.getWorldQuaternion(THREE.Quaternion.temp()),t.postMessage("world body "+this.id+" position = "+s.stringifyParam(n.position)),t.postMessage("world body "+this.id+" quaternion = "+s.stringifyParam(n.quaternion))})),this.data.autoShape&&!this.el.getAttribute("shape"))if(this.el.firstElementChild){let t=this.el.querySelectorAll("a-box, a-sphere, a-cylinder");t&&t.forEach((t=>{t.getAttribute("shape")||t.setAttribute("shape",!0)}))}else this.el.setAttribute("shape",!0);this._initiated=!0},play:function(){this._initiated||(this.init(),this.update({}))},update:function(t){let e=this.el.sceneEl.systems.physics.worker;e&&(this.data.type!==t.type&&e.postMessage("world body "+this.id+" type = "+s.stringifyParam(this.data.type)),this.data.mass!==t.mass&&e.postMessage("world body "+this.id+" mass = "+s.stringifyParam(this.data.mass)),this.data.belongsTo!==t.belongsTo&&e.postMessage("world body "+this.id+" belongsTo = "+s.stringifyParam(this.data.belongsTo)),this.data.collidesWith!==t.collidesWith&&e.postMessage("world body "+this.id+" collidesWith = "+s.stringifyParam(this.data.collidesWith)),this.data.emitsWith!==t.emitsWith&&e.postMessage("world body "+this.id+" emitsWith = "+s.stringifyParam(this.data.emitsWith)),setTimeout((()=>{e.postMessage("world body "+this.id+" sleeping = "+!!this.data.sleeping)})))},sleep:function(){let t=this.el.sceneEl.systems.physics.worker;t&&(t.postMessage("world body "+this.id+" sleeping = true"),this.sleeping=!0)},pause:function(){if(this.data.autoShape&&(this.el.removeAttribute("shape"),this.el.firstElementChild)){let t=this.el.querySelectorAll("a-box, a-sphere, a-cylinder");t&&t.forEach((t=>{t.removeAttribute("shape")}))}let t=this.el.sceneEl.systems.physics.worker,e=this.el.sceneEl.systems.physics.bodies,i=this.el.sceneEl.systems.physics.movingBodies;t&&(e[this.id]=null,null!==this.mid&&(i[this.mid]=null),t.postMessage("world body "+this.id+" remove"),this._initiated=!1)},tick:function(){let t=this.el.sceneEl.systems.physics.worker,e=this.el.sceneEl.systems.physics.buffers[0];if(t&&null!==this.mid){let t=8*this.mid;if(e.length<=t)return;if("kinematic"===this.data.type){let i=this.el.object3D.getWorldPosition(THREE.Vector3.temp());e[t++]=i.x,e[t++]=i.y,e[t++]=i.z,this.sleeping=!!e[t++];let s=this.el.object3D.getWorldQuaternion(THREE.Quaternion.temp());e[t++]=s.x,e[t++]=s.y,e[t++]=s.z,e[t++]=s.w}else if(e[t+1]){let i=THREE.Quaternion.temp();this.el.object3D.position.set(e[t++],e[t++],e[t++]),this.el.object3D.parent.worldToLocal(this.el.object3D.position),this.sleeping=!!e[t++],this.el.object3D.getWorldQuaternion(i),this.el.object3D.quaternion.multiply(i.conjugate().normalize()),i.set(e[t++],e[t++],e[t++],e[t++]),this.el.object3D.quaternion.multiply(i.normalize())}}},command:function(t){switch(t.shift()){case"emits":let e=t.shift();switch(e.event){case"collision":let t=this.el.sceneEl.systems.physics.bodies;if(e.body1=t[e.body1],e.body2=t[e.body2],!e.body1||!e.body2)return;e.shape1=e.body1.components.body.shapes[e.shape1],e.shape2=e.body2.components.body.shapes[e.shape2]}this.el.emit(e.event,e)}}})},{"../../libs/cmdCodec":15}],13:[function(t,e,i){const s=t("../../libs/cmdCodec");AFRAME.registerComponent("joint",{multiple:!0,schema:{type:{type:"string",default:"ball"},body1:{type:"selector"},body2:{type:"selector"},pivot1:{type:"vec3",default:{x:0,y:0,z:0}},pivot2:{type:"vec3",default:{x:0,y:0,z:0}},axis1:{type:"vec3",default:{x:0,y:1,z:0}},axis2:{type:"vec3",default:{x:0,y:1,z:0}},min:{type:"number",default:0},max:{type:"number",default:1},collision:{type:"boolean",default:!0}},init:function(){let t=this.el.sceneEl.systems.physics.worker,e=this.el.sceneEl.systems.physics.joints;t&&(this.id=e.indexOf(null),this.id<0&&(this.id=e.length),e[this.id]=this.el,setTimeout((()=>{let e={};e.type=this.data.type,e.body1=this.data.body1?this.data.body1.components.body.id:this.el.components.body.id,e.body2=this.data.body2.components.body.id,e.pivot1=this.data.pivot1,e.pivot2=this.data.pivot2,e.axis1=this.data.axis1,e.axis2=this.data.axis2,e.min=this.data.min,e.max=this.data.max,e.collision=this.data.collision,t.postMessage("world joint "+this.id+" create "+s.stringifyParam(e))})))},update:function(t){this.el.sceneEl.systems.physics.worker},remove:function(){let t=this.el.sceneEl.systems.physics.worker,e=this.el.sceneEl.systems.physics.joints;t&&(e[this.id]=null,t.postMessage("world joint "+this.id+" remove"))}})},{"../../libs/cmdCodec":15}],14:[function(t,e,i){const s=t("../../libs/cmdCodec");AFRAME.registerComponent("shape",{multiple:!0,schema:{},init:function(){let t=this.el.sceneEl.systems.physics.worker;if(!t)return;for(this.body=this.el;this.body&&!this.body.matches("[body]");)this.body=this.body.parentElement;if(!this.body)return this._retry=setTimeout((()=>{this.init()}),256);this.bodyId=this.body.components.body.id;let e=this.body.components.body.shapes;this.id=e.indexOf(null),this.id<0&&(this.id=e.length),e[this.id]=this.el;let i={};i.position=this.el.object3D.getWorldPosition(THREE.Vector3.temp()),this.body.object3D.worldToLocal(i.position),i.quaternion=this.el.object3D.getWorldQuaternion(THREE.Quaternion.temp());let o=this.body.object3D.getWorldQuaternion(THREE.Quaternion.temp());switch(i.quaternion.multiply(o.conjugate().normalize()).normalize(),i.size=THREE.Vector3.temp().set(1,1,1),this.el.tagName.toLowerCase()){case"a-sphere":i.type="sphere",i.size.multiplyScalar(2*parseFloat(this.el.getAttribute("radius")||1));break;case"a-cylinder":i.type="cylinder",i.size.multiplyScalar(2*parseFloat(this.el.getAttribute("radius")||1)).y=parseFloat(this.el.getAttribute("height")||1);break;case"a-box":i.type="box",i.size.set(parseFloat(this.el.getAttribute("width")||1),parseFloat(this.el.getAttribute("height")||1),parseFloat(this.el.getAttribute("depth")||1))}i.size.multiply(this.el.object3D.getWorldScale(THREE.Vector3.temp())),t.postMessage("world body "+this.bodyId+" shape "+this.id+" create "+s.stringifyParam(i))},update:function(){},remove:function(){if(clearTimeout(this._retry),!this.body)return;let t=this.el.sceneEl.systems.physics.worker;if(!t)return;let e=this.body.components.body.shapes;t.postMessage("world body "+this.bodyId+" shape "+this.id+" remove"),e[this.id]=null}})},{"../../libs/cmdCodec":15}],15:[function(t,e,i){e.exports={parse:function(t){let e=t.split(" "),i=[];for(let t of e)if(t)try{i.push(JSON.parse(t))}catch(e){"="!==t&&i.push(t)}return i},stringifyParam:function(t){return JSON.stringify(t).replaceAll(" ","\\u0020").replaceAll('"_','"')}}},{}],16:[function(t,e,i){AFRAME.AEntity.prototype.copyWorldPosRot=function(t){let e=THREE.Quaternion.temp(),i=t.object3D,s=this.object3D;i&&s&&s.parent&&(i.getWorldPosition(s.position),s.parent.worldToLocal(s.position),s.getWorldQuaternion(e),s.quaternion.multiply(e.conjugate().normalize()),i.getWorldQuaternion(e),s.quaternion.multiply(e.normalize()))}},{}],17:[function(t,e,i){Element.prototype.ensure=function(t,e=t,i={}){let s,o,n;if(s=this.querySelector(t),!s)for(o in s=document.createElement(e),this.appendChild(s),i)n=i[o],s.setAttribute(o,n);return s}},{}],18:[function(t,e,i){function s(t){t._pool=[],t._inUse=[],t.temp=function(){let e=t._pool.pop()||new t;return t._inUse.push(e),t._gc||(t._gc=setTimeout(t._recycle)),e},t._recycle=function(){for(;t._inUse.length;)t._pool.push(t._inUse.pop());t._gc=!1}}s(THREE.Vector2),s(THREE.Vector3),s(THREE.Quaternion),s(THREE.Matrix3),s(THREE.Matrix4)},{}],19:[function(t,e,i){let s=Element.prototype.addEventListener,o=Element.prototype.removeEventListener,n=t=>{if(t._tgest)return t._tgest;let e,i,s,o;t._tgest={handlers:{swipeup:[],swipedown:[],swipeleft:[],swiperight:[],tap:[],hold:[]}};let n=(e,i)=>{if(t._tgest.handlers[e])for(let s of t._tgest.handlers[e])s(i);else console.log(e,t._tgest.handlers[e])};return t.addEventListener("touchstart",(t=>{e=t.changedTouches[0].screenX,i=t.changedTouches[0].screenY,o=!1,s=setTimeout((()=>{o=!0,n("hold",t)}),512)})),t.addEventListener("touchmove",(t=>{let r=t.changedTouches[0].screenX,a=t.changedTouches[0].screenY;if(Math.sqrt(Math.pow(e-r,2)+Math.pow(i-a,2))>32){if(clearTimeout(s),o)return;Math.abs(e-r)>Math.abs(i-a)?n(r<e?"swipeleft":"swiperight",t):n(a<i?"swipeup":"swipedown",t),o=!0}})),t.addEventListener("touchend",(t=>{clearTimeout(s);let r=t.changedTouches[0].screenX,a=t.changedTouches[0].screenY;if(Math.sqrt(Math.pow(e-r,2)+Math.pow(i-a,2))<32){if(o)return;n("tap",t)}})),t._tgest};Element.prototype.addEventListener=function(t,e){switch(t){case"swipeup":case"swipedown":case"swipeleft":case"swiperight":case"tap":case"hold":n(this).handlers[t].push(e);break;default:return s.call(this,t,e)}},Element.prototype.removeEventListener=function(t,e){switch(t){case"swipeup":case"swipedown":case"swipeleft":case"swiperight":case"tap":case"hold":let i=n(this),s=i.handlers[t].indexOf(e);s>=0&&i.handlers[t].splice(s,1);break;default:return o.call(this,t,e)}}},{}],20:[function(t,e,i){AFRAME.registerPrimitive("a-hand",{mappings:{side:"hand-controls.hand",color:"hand-controls.color",model:"hand-controls.handModelStyle"}})},{}],21:[function(t,e,i){AFRAME.registerPrimitive("a-main",{})},{}],22:[function(t,e,i){AFRAME.registerPrimitive("a-player",{defaultComponents:{injectplayer:{}}})},{}]},{},[2]);
